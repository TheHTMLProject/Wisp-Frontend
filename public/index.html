<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="canonical" href="https://lightlink.space/" />
    <title>lightlink</title>
    <meta name="title" content="lightlink">
    <meta name="description" content="lightlink - get your homework done, with style...">
    <meta property="og:title" content="lightlink">
    <meta property="og:description" content="lightlink - get your homework done, with style...">
    <meta property="og:image" content="/favicon.ico">
    <meta name="image" content="/favicon.ico">
    <meta property="og:url" content="/">
    <meta name="url" content="/">
    <link rel="manifest" href="/manifest.json">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .lucide {
            width: 1.2rem;
            height: 1.2rem;
            stroke-width: 2;
        }
    </style>
    <script src="/js/3js.js"></script>
    <script src="/js/vanta.fog.js"></script>
    <script src="/js/draggable.js"></script>
    <script src="/js/gsap.js"></script>
    <script src="/js/p5.js"></script>
    <script src="/register-sw.js"></script>
    <script src="/js/something.js"></script>
    <script src="/astronomy/engine-controller.js" type="module"></script>
    <script src="/js/alsosomething.js"></script>
    <script src="/js/socketio.js"></script>
    <script src="/astronomy/engine.js"></script>
    <script src="/config-astronomy.js"></script>
    <script>
        // Standard Plain Text Codec - Matches Service Worker Defaults
        window.ASTRONOMY_CONFIG = {
            prefix: '/astronomy/',
            codec: {
                encode: "url => {\n                    if (!url) return url;\n                    const [path, ...query] = url.split('?');\n                    return encodeURIComponent(path.split('').map((char, ind) => ind % 2 ? String.fromCharCode(char.charCodeAt(0) ^ 2) : char).join('')) + (query.length ? '?' + query.join('?') : '');\n                }",
                decode: "url => {\n                    if (!url) return url;\n                    let input = url;\n                    const match = url.match(/^([a-z0-9]{8}\\/[a-z0-9]{8}\\/)(.*)$/);\n                    if (match) {\n                        input = match[2];\n                    }\n                    const [path, ...query] = input.split('?');\n                    return decodeURIComponent(path).split('').map((char, ind) => ind % 2 ? String.fromCharCode(char.charCodeAt(0) ^ 2) : char).join('') + (query.length ? '?' + query.join('?') : '');\n                }"
            }
        };
        let ASTRONOMY_CONFIG = window.ASTRONOMY_CONFIG;
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            try {
                VANTA.FOG({
                    el: "#vanta-bg",
                    mouseControls: true,
                    touchControls: true,
                    gyroControls: false,
                    minHeight: 200.00,
                    minWidth: 200.00,
                    highlightColor: 0x0,
                    midtoneColor: 0x393939,
                    lowlightColor: 0x2a2a2a,
                    baseColor: 0x202020,
                    blurFactor: 0.90
                });
            } catch (e) {
                console.error("Vanta error:", e);
            }
        });
    </script>
    <script type="module">
        "use strict";

        import { Controller } from "/astronomy/engine-controller.js";
        window.ScramjetController = Controller;



        document.addEventListener("DOMContentLoaded", async () => {
            const form = document.getElementById("sj-form");
            const address = document.getElementById("sj-address");
            const searchEngine = document.getElementById("sj-search-engine");
            const error = document.getElementById("sj-error");
            const frame = document.getElementById("sj-frame");

            // 1. Initialize BareMux (Single Instance)
            const connection = new BareMux.BareMuxConnection("/baremux/worker.js");

            // Set up epoxy transport first
            const wispUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/wisp/";
            await connection.setTransport("/epoxy/index.mjs", [{ wisp: wispUrl }]).catch(e => { });

            // Create BareClient for proxied requests
            const bareClient = new BareMux.BareClient("/baremux/worker.js");
            window.bareClient = bareClient; // Expose globally for Activities proxy fetches

            // Create a transport wrapper that uses BareClient for proper proxying
            // Blocked ad/tracker domains (Anyclip, prebid, ad exchanges, etc.)
            const BLOCKED_AD_DOMAINS = [
                'anyclip.com', 'player.anyclip.com',
                'prebid.media.net', 'prebid.publishernetwork.com',
                'id5-sync.com', 'idsync.com',
                'googlesyndication.com', 'googleadservices.com',
                'doubleclick.net', 'adservice.google.com',
                'amazon-adsystem.com', 'aps.amazon.com',
                'rubiconproject.com', 'fastlane.rubiconproject.com',
                'pubmatic.com', 'ads.pubmatic.com',
                'openx.net', 'exchange.openx.com',
                'casalemedia.com',
                'indexexchange.com',
                'sovrn.com', 'ap.lijit.com',
                'sharethrough.com',
                'triplelift.com',
                'criteo.com', 'bidder.criteo.com',
                'taboola.com', 'cdn.taboola.com',
                'outbrain.com',
                'contextweb.com',
                'yieldmo.com',
                'kargo.com',
                'smartadserver.com',
                'adnxs.com', 'ib.adnxs.com',
                'bidswitch.net',
                'ssp.yahoo.com',
                'ads.yahoo.com',
                'advertising.com',
                'quantserve.com',
                'moatads.com',
                'doubleverify.com',
                'adsrvr.org',
                'demdex.net',
                'krxd.net',
                'bluekai.com',
                'scorecardresearch.com',
                'imrworldwide.com',
                'connatix.com',
                'justpremium.com',
                'gumgum.com',
                '33across.com',
                'districtm.io',
            ];
            function isBlockedAdUrl(url) {
                try {
                    const hostname = new URL(url).hostname;
                    return BLOCKED_AD_DOMAINS.some(d => hostname === d || hostname.endsWith('.' + d));
                } catch { return false; }
            }

            const transport = {
                ready: true, // BareClient handles readiness internally
                async init() {
                    return this;
                },
                async request(url, method, body, headers, signal) {
                    // Block ad/tracker requests before they hit the proxy
                    const urlStr = url.toString();
                    if (isBlockedAdUrl(urlStr)) {
                        return {
                            body: new ReadableStream({ start(c) { c.close(); } }),
                            status: 200,
                            statusText: 'OK (Blocked)',
                            headers: [['content-type', 'text/plain']]
                        };
                    }

                    // Use BareClient.fetch() which properly proxies through BareMux worker
                    const fetchOpts = {
                        method: method || 'GET',
                        body: body,
                        headers: headers instanceof Array ? Object.fromEntries(headers) : headers,
                        signal: signal
                    };
                    // Chrome requires duplex:'half' for requests with streaming bodies
                    if (body) fetchOpts.duplex = 'half';

                    const response = await bareClient.fetch(urlStr, fetchOpts);
                    return {
                        body: response.body,
                        status: response.status,
                        statusText: response.statusText,
                        headers: response.rawHeaders ?
                            (Array.isArray(response.rawHeaders) ? response.rawHeaders : Object.entries(response.rawHeaders)) :
                            [...response.headers.entries()]
                    };
                },
                connect(url, protocols, headers, onOpen, onData, onClose, onError) {
                    // WebSocket connection through BareClient
                    const ws = bareClient.createWebSocket(url.toString(), protocols, null, headers);
                    ws.addEventListener('open', () => onOpen(ws.protocols || '', ''));
                    ws.addEventListener('message', (e) => onData(e.data));
                    ws.addEventListener('close', (e) => onClose(e.code, e.reason));
                    ws.addEventListener('error', () => onError('WebSocket error'));
                    return [
                        (data) => ws.send(data),
                        (code, reason) => ws.close(code, reason)
                    ];
                }
            };

            let controller;

            // 2. Main Initialization Function
            async function initController() {
                if (controller) return controller;

                if (!('serviceWorker' in navigator)) {
                }
                const registration = await navigator.serviceWorker.register('/sw-astronomy.js', {
                    type: 'module',
                    scope: '/'
                });

                if (registration.installing) {
                    await new Promise(resolve => {
                        registration.installing.addEventListener('statechange', (e) => {
                            if (e.target.state === 'activated') resolve();
                        });
                        // Add timeout to prevent infinite wait
                        setTimeout(() => {
                            resolve();
                        }, 5000);
                    });
                } else if (registration.waiting) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                } else {
                }

                // Wait for controller claim
                if (!navigator.serviceWorker.controller) {

                    // Listen for controller change event
                    const controllerPromise = new Promise(resolve => {
                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            resolve(navigator.serviceWorker.controller);
                        });
                    });

                    // Also poll in case event doesn't fire
                    const pollPromise = new Promise(resolve => {
                        const check = () => {
                            if (navigator.serviceWorker.controller) {
                                resolve(navigator.serviceWorker.controller);
                            } else {
                                setTimeout(check, 50);
                            }
                        };
                        check();
                    });

                    // Race between event and timeout
                    const result = await Promise.race([
                        Promise.race([controllerPromise, pollPromise]),
                        new Promise(resolve => setTimeout(() => resolve(null), 5000))
                    ]);

                    if (!result && !navigator.serviceWorker.controller) {
                        window.location.reload();
                        return; // Stop execution, page will reload
                    }
                }

                // Final check - don't proceed without controller
                if (!navigator.serviceWorker.controller) {
                }

                // Init Scramjet

                // Use codec from ASTRONOMY_CONFIG if available, fallback to none
                const codecConfig = (typeof ASTRONOMY_CONFIG !== 'undefined' && ASTRONOMY_CONFIG.codec) ? {
                    encode: eval(ASTRONOMY_CONFIG.codec.encode),
                    decode: eval(ASTRONOMY_CONFIG.codec.decode)
                } : {
                    encode: url => url ? encodeURIComponent(url) : url,
                    decode: url => url ? decodeURIComponent(url) : url
                };

                controller = new Controller({
                    serviceworker: navigator.serviceWorker.controller,
                    transport: transport,
                    prefix: "/astronomy/",
                    codec: codecConfig,
                    files: {
                        wasm: '/astronomy/engine.wasm',
                        worker: '/astronomy/engine-inject.js',
                        client: '/astronomy/engine-inject.js',
                        shared: '/astronomy/engine-inject.js',
                        sync: '/astronomy/engine-inject.js',
                    },
                });

                await controller.wait();

                let frame = null;
                try {
                    frame = await controller.createFrame(window);
                } catch (e) {
                }

                window.scramjet = {
                    frame: frame,
                    controller: controller,
                    encodeUrl: (url) => {
                        if (!url) return url;
                        if (url.startsWith('http')) {
                            return (frame ? frame.prefix : controller.prefix) + codecConfig.encode(url);
                        }
                        return url;
                    },
                    decodeUrl: (url) => {
                        if (!url) return url;
                        const prefix = frame ? frame.prefix : controller.prefix;
                        if (url.toString().startsWith(prefix)) {
                            return codecConfig.decode(url.toString().substring(prefix.length));
                        }
                        return url;
                    }
                };

                if (window.resolveControllerReady) window.resolveControllerReady(controller);
                return controller;
            }

            initController().catch(e => {
                if (window.resolveControllerReady) window.resolveControllerReady(null);
                if (error) error.textContent = "Initialization failed: " + e.message;
            });

            if (form) {
                form.addEventListener("submit", async (event) => {
                    event.preventDefault();

                    try {
                        await window.controllerReadyPromise;

                        const query = address.value;
                        const engine = searchEngine ? searchEngine.value : "https://google.com/search?q=%s";
                        const url = query.includes('.') && !query.includes(' ') ?
                            (query.startsWith('http') ? query : `https://${query}`) :
                            engine.replace('%s', encodeURIComponent(query));

                        let wispUrl = (location.protocol === "https:" ? "wss" : "ws") + "://" + location.host + "/wisp/";

                        // Setup Transport if needed
                        if ((await connection.getTransport()) !== "/epoxy/index.mjs") {
                            await connection.setTransport("/epoxy/index.mjs", [{ wisp: wispUrl }]);
                        }

                        if (frame) {
                            frame.style.display = "block";
                            frame.src = window.scramjet.encodeUrl(url);
                        }

                    } catch (err) {
                        if (error) error.textContent = "Error: " + err.message;
                    }
                });
            }
        });
    </script>

    <style>
        #vanta-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
            /* Let clicks pass through */
        }

        .activities-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 30px;
            box-sizing: border-box;
            overflow: hidden;
            background: transparent;
        }

        .activities-container .games-topbar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            position: relative;
            z-index: 10;
        }

        .activities-container .games-search-bar {
            width: 100%;
            max-width: 500px;
            height: 50px;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 0 16px;
            transition: all 0.3s ease;
        }

        .activities-container .games-search-bar:focus-within {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .activities-container .games-search-icon {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.5);
            margin-right: 12px;
        }

        .activities-container .activity-search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 16px;
            height: 100%;
            outline: none;
        }

        .activities-container .activity-search-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .activities-container .games-refresh-btn,
        .activities-container .games-filter-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.2s;
        }

        .activities-container .games-refresh-btn:hover,
        .activities-container .games-filter-btn:hover,
        .activities-container .games-filter-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            transform: scale(1.05);
        }

        .activities-container .game-grid-container {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
        }

        .activities-container .game-grid-container::-webkit-scrollbar {
            width: 6px;
        }

        .activities-container .game-grid-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .activities-container .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1400px;
            padding: 20px;
            box-sizing: border-box;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            aspect-ratio: 1 / 1.3;
            display: flex;
            flex-direction: column;
        }

        .game-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .game-card img {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            background: rgba(0, 0, 0, 0.2);
            transition: opacity 0.3s;
        }

        .game-card .game-info {
            padding: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .game-card h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.4;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .no-results-message {
            margin-top: 40px;
            color: rgba(255, 255, 255, 0.4);
            font-size: 16px;
            text-align: center;
            display: none;
        }

        .game-card.skeleton {
            pointer-events: none;
        }

        .game-card.skeleton .game-image {
            width: 100%;
            aspect-ratio: 1/1;
            background: rgba(255, 255, 255, 0.05);
            animation: pulse 1.5s infinite ease-in-out;
        }

        .game-card.skeleton .skeleton-text {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            margin: 0 auto;
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0% {
                opacity: 0.4;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 0.4;
            }
        }

        /* Filters Menu */
        .games-filters-menu {
            position: absolute;
            top: 60px;
            right: 0;
            width: 300px;
            background: rgba(20, 20, 25, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            display: none;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.2s ease-out;
        }

        .games-filters-menu.active {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            color: #fff;
            outline: none;
            font-size: 14px;
        }

        .filter-group select option {
            background: #222;
            color: #fff;
        }

        .rss-display {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-family: monospace;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            word-break: break-all;
            user-select: all;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        @font-face {
            font-family: 'Geist';
            src: url('/fonts/Geist-Thin.ttf') format('truetype');
            font-weight: 100;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Geist';
            src: url('/fonts/Geist-ExtraLight.ttf') format('truetype');
            font-weight: 200;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Geist';
            src: url('/fonts/Geist-Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Geist';
            src: url('/fonts/Geist-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Geist';
            src: url('/fonts/Geist-Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Geist';
            src: url('/fonts/Geist-SemiBold.ttf') format('truetype');
            font-weight: 600;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Geist';
            src: url('/fonts/Geist-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Geist';
            src: url('/fonts/Geist-ExtraBold.ttf') format('truetype');
            font-weight: 800;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Geist';
            src: url('/fonts/Geist-Black.ttf') format('truetype');
            font-weight: 900;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --bg-main: #27272a;
            --bg-secondary: #18181b;
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --accent: #3b82f6;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Geist', sans-serif;
            outline: none;
            user-select: none;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: transparent;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
        }

        #vanta-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .ri-icon {
            font-size: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .dock.glass-surface {
            --bg-color: transparent !important;
            display: flex;
            gap: 20px;
            padding: 18px 24px;
            transition: background 0.3s ease, border-color 0.3s ease;
        }

        .dock-app {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: rgba(255, 255, 255, 0.5);
            background: transparent;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                color 0.2s ease,
                filter 0.2s ease,
                box-shadow 0.2s ease;
            position: relative;
        }

        .dock-app:hover {
            transform: translateY(-3px) scale(1.05);
            background: transparent;
            color: #fff;
        }

        .dock-app .tooltip {
            position: absolute;
            bottom: -30px;
            font-size: 11px;
            background: #18181b;
            color: #fff;
            padding: 3px 8px;
            border-radius: 4px;
            opacity: 0;
            pointer-events: none;
            transition: 0.2s;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dock-app:hover .tooltip {
            opacity: 1;
            bottom: -40px;
        }


        @keyframes settingsRotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @keyframes blockRotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(90deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .dock-app.app-settings:hover i {
            animation: settingsRotate 0.6s ease-in-out;
        }

        .dock-app.app-blocks:hover i,
        .dock-app.app-blocks-backup:hover i {
            animation: blockRotate 0.4s ease-in-out forwards;
        }


        .dock-app.app-profiles,
        .dock-app.app-activities {
            position: relative;
        }

        .dock-app.app-profiles .icon-main,
        .dock-app.app-activities .icon-main {
            position: relative;
            z-index: 3;
            transition: transform 0.3s ease;
        }

        .dock-app.app-profiles .icon-bg-left,
        .dock-app.app-profiles .icon-bg-right,
        .dock-app.app-activities .icon-bg-left,
        .dock-app.app-activities .icon-bg-right {
            position: absolute;
            opacity: 0;
            transform: scale(0.85);
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.5);
            font-size: 20px !important;
        }

        .dock-app.app-profiles .icon-bg-left,
        .dock-app.app-activities .icon-bg-left {
            left: 2px;
            z-index: 1;
        }

        .dock-app.app-profiles .icon-bg-right,
        .dock-app.app-activities .icon-bg-right {
            right: 2px;
            z-index: 2;
        }

        .dock-app.app-profiles:hover .icon-main,
        .dock-app.app-activities:hover .icon-main {
            transform: scale(1.1);
        }

        .dock-app.app-profiles:hover .icon-bg-left,
        .dock-app.app-activities:hover .icon-bg-left {
            opacity: 1;
            transform: scale(0.85) translateX(-8px);
        }

        .dock-app.app-profiles:hover .icon-bg-right,
        .dock-app.app-activities:hover .icon-bg-right {
            opacity: 1;
            transform: scale(0.85) translateX(8px);
        }


        .dock-app.app-videos .icon-play {
            display: inline-block;
        }

        .dock-app.app-videos .icon-pause {
            display: none;
        }

        .dock-app.app-videos:hover .icon-play {
            display: none;
        }

        .dock-app.app-videos:hover .icon-pause {
            display: inline-block;
            animation: fadeIn 0.2s ease;
        }

        .nt-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.4s ease-out;
        }

        .nt-header-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .nt-clock {
            font-size: 4rem;
            font-weight: 800;
            letter-spacing: -1px;
            color: #f4f4f5;
            text-shadow:
                0 4px 12px rgba(0, 0, 0, 0.2),
                0 0 40px rgba(255, 255, 255, 0.05);
            margin-bottom: 5px;
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nt-clock:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 0 20px rgba(0, 0, 0, 0.05));
            text-shadow:
                0 0 25px rgba(0, 0, 0, 0.1),
                0 0 60px rgba(0, 0, 0, 0.05);
        }

        .nt-greeting {
            font-family: 'Geist', sans-serif;
            font-size: 1.5rem;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.5);
            transition: opacity 0.5s ease, width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.05);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nt-sub-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
            margin-bottom: 40px;
        }

        .nt-weather {
            display: flex;
            align-items: center;
            gap: 6px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease;
            overflow: hidden;
            white-space: nowrap;
        }

        #settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: min(90%, 720px);
            height: min(85%, 600px);
            background: transparent;
            backdrop-filter: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            z-index: 2001;
            opacity: 0;
            pointer-events: none;
            transition: all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: none;
        }

        #settings-modal.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        #settings-glass-bg {
            position: fixed;
            inset: 0;
            z-index: 1999;
            background: rgba(20, 20, 25, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            filter: url(#glass-distortion) saturate(120%) brightness(1.15);
            pointer-events: none;
            will-change: opacity, transform;
            transform: translate3d(0, 0, 0);
            opacity: 0;
            display: none;
            transition: opacity 0.3s ease;
        }

        #settings-glass-bg.active {
            display: block;
            opacity: 1;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.06);
            color: rgba(255, 255, 255, 0.5);
            transition: all 0.2s;
            z-index: 10;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            transform: scale(1.05);
        }


        .site-ban-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #fffafa 0%, #fff0f0 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999999;
            flex-direction: column;
        }

        .site-ban-overlay.active {
            display: flex;
        }

        .site-ban-icon {
            font-size: 120px;
            margin-bottom: 30px;
            color: #ef4444;
            animation: banPulse 1.5s ease-in-out infinite;
        }

        @keyframes banPulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .site-ban-title {
            font-size: 48px;
            color: #ef4444;
            margin-bottom: 20px;
        }

        .site-ban-reason {
            font-size: 20px;
            color: #b91c1c;
            line-height: 1.6;
            text-align: center;
            max-width: 600px;
            margin-bottom: 30px;
        }

        .site-ban-info {
            font-size: 14px;
            color: #999;
        }


        .site-warning-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(18, 18, 18, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99998;
            backdrop-filter: blur(10px);
        }

        .site-warning-overlay.active {
            display: flex;
        }

        .site-warning-box {
            background: linear-gradient(135deg, #1e1b4b 0%, #1e1b4b 100%);
            border: 2px solid #f59e0b;
            border-radius: 20px;
            padding: 50px;
            max-width: 550px;
            text-align: center;
            box-shadow: 0 0 80px rgba(245, 158, 11, 0.2);
            animation: warningGlow 2s ease-in-out infinite;
        }

        @keyframes warningGlow {

            0%,
            100% {
                box-shadow: 0 0 60px rgba(245, 158, 11, 0.1);
            }

            50% {
                box-shadow: 0 0 100px rgba(245, 158, 11, 0.2);
            }
        }

        .site-warning-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .site-warning-title {
            font-size: 36px;
            font-weight: bold;
            color: #f59e0b;
            margin-bottom: 20px;
        }

        .site-warning-message {
            font-size: 18px;
            color: #b45309;
            line-height: 1.6;
            margin-bottom: 35px;
        }

        .site-warning-dismiss {
            padding: 16px 50px;
            background: #f59e0b;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .site-warning-dismiss:hover {
            background: #fbbf24;
            transform: scale(1.05);
        }


        #notification-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(30px);
            border-left: 1px solid rgba(0, 0, 0, 0.05);
            z-index: 100000;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -20px 0 50px rgba(0, 0, 0, 0.05);
        }

        #notification-panel.active {
            transform: translateX(-400px);
        }

        .notif-header {
            padding: 30px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .notif-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.5px;
            color: #fff;
        }

        .notif-close {
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            color: rgba(0, 0, 0, 0.4);
            transition: all 0.2s;
        }

        .notif-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .notif-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .notif-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: rgba(255, 255, 255, 0.3);
            margin: 0 0 16px 0;
        }

        .notif-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: transform 0.2s, background 0.2s;
        }

        .notif-item:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .notif-item .title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: #fff;
        }

        .notif-item .desc {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            line-height: 1.4;
        }

        .notif-item .date {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.3);
            margin-top: 8px;
        }

        .changelog-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 8px;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .announcement-tag {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .notif-empty {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            padding: 40px 0;
            font-size: 0.9rem;
        }

        #notification-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 99999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #notification-overlay.active {
            display: block;
            opacity: 1;
        }


        #tos-overlay {
            position: fixed;
            inset: 0;
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(20px);
            z-index: 2000005;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #tos-overlay.active {
            display: flex;
            opacity: 1;
        }

        .tos-modal {
            background: #18181b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.05);
            transform: translateY(30px);
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        #tos-overlay.active .tos-modal {
            transform: translateY(0);
        }

        .tos-header {
            margin-bottom: 24px;
        }

        .tos-icon {
            font-size: 40px;
            margin-bottom: 12px;
            color: #3b82f6;
            display: inline-block;
        }

        .tos-title {
            font-size: 1.6rem;
            font-weight: 800;
            margin: 0;
            letter-spacing: -0.8px;
            color: #fff;
        }

        .tos-content {
            flex: 1;
            overflow-y: auto;
            text-align: left;
            padding-right: 12px;
            margin-bottom: 30px;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.1) transparent;
        }

        .tos-content::-webkit-scrollbar {
            width: 6px;
        }

        .tos-content::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .tos-section {
            margin-bottom: 24px;
        }

        .tos-section h4 {
            font-size: 0.9rem;
            font-weight: 700;
            color: #fff;
            margin: 0 0 8px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tos-section p {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
            line-height: 1.6;
            margin: 0;
        }

        .tos-footer {
            margin-top: auto;
            display: flex;
            gap: 12px;
        }

        .tos-accept-btn,
        .tos-decline-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tos-accept-btn {
            background: #000;
            color: #fff;
        }

        .tos-decline-btn {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tos-accept-btn:hover {
            background: #3b82f6;
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.2);
        }

        .tos-decline-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: #ef4444;
        }

        #privacy-popover {
            position: absolute;
            top: 50px;
            bottom: auto;
            left: 0;
            width: 300px;
            background: #18181b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            z-index: 10000;
            display: none;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            /* Triangle pointing down */
        }

        #privacy-popover::before {
            content: '';
            position: absolute;
            top: -6px;
            bottom: auto;
            left: 20px;
            width: 12px;
            height: 12px;
            background: #18181b;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: none;
            border-right: none;
            transform: rotate(45deg);
        }

        #privacy-popover.active {
            display: flex;
            animation: popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .privacy-header-small {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .privacy-body-small p {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.5;
            margin: 0;
        }

        #auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(30px);
            z-index: 2000010;
            /* Above TOS */
            display: none;
            align-items: center;
            justify-content: center;
        }

        .auth-modal {
            background: #18181b;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            width: 400px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .auth-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 8px;
        }

        .auth-subtitle {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .auth-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            margin-bottom: 12px;
            width: 100%;
        }

        .auth-btn {
            background: #fff;
            color: #000;
            font-weight: 700;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            margin-top: 12px;
            transition: 0.2s;
        }

        .auth-btn:hover {
            transform: scale(1.02);
            background: #eee;
        }

        .auth-link {
            text-align: center;
            margin-top: 16px;
            font-size: 0.8rem;
            color: #3b82f6;
            cursor: pointer;
        }

        .auth-error {
            color: #ef4444;
            font-size: 0.8rem;
            margin-bottom: 10px;
            display: none;
            text-align: center;
        }

        .glass-search,
        .glass-surface {
            --bg-color: rgba(255, 255, 255, 0.25);
            --highlight: rgba(255, 255, 255, 0.75);
            --text: #ffffff;
            --input-bg: rgba(255, 255, 255, 0.1);
            --input-border: rgba(255, 255, 255, 0.2);
            --input-focus: rgba(255, 255, 255, 0.3);

            position: relative;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
        }

        .glass-search {
            width: 500px;
        }

        .glass-filter,
        .glass-overlay,
        .glass-specular {
            position: absolute;
            inset: 0;
            border-radius: inherit;
        }

        .glass-filter {
            z-index: 1;
            backdrop-filter: blur(4px);
            filter: url(#glass-distortion) saturate(120%) brightness(1.15);
        }

        .glass-overlay {
            z-index: 2;
            background: var(--bg-color);
        }

        .glass-specular {
            z-index: 3;

            box-shadow: none;
        }

        .glass-content {
            position: relative;
            z-index: 4;
            color: var(--text);
        }


        .search-container {
            position: relative;
            padding: 20px;
            display: flex;
            align-items: center;
            transition: padding 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-container.expanded {
            padding: 25px 20px;
        }

        .search-icon {
            position: absolute;
            left: 35px;
            font-size: 18px;
            color: var(--text);
            opacity: 0.8;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
        }

        .search-container.expanded .search-icon {
            transform: scale(1.1);
            opacity: 1;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 12px;
            color: var(--text);
            font-size: 16px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, box-shadow, background;
        }

        .search-input:focus {
            outline: none;
            background: var(--input-focus);
            border-color: var(--highlight);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .search-input:focus+.search-icon {
            opacity: 1;
            transform: scale(1.1) translateY(-2px);
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
            transition: opacity 0.3s ease;
        }

        .search-input:focus::placeholder {
            opacity: 0.4;
        }

        .search-clear {
            position: absolute;
            right: 35px;
            background: none;
            border: none;
            color: var(--text);
            opacity: 0;
            cursor: pointer;
            font-size: 16px;
            transition: opacity 0.3s ease;
            padding: 5px;
            border-radius: 50%;
        }

        .search-clear:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .search-input:not(:placeholder-shown)+.search-icon+.search-clear {
            opacity: 0.7;
        }


        .search-suggestions {
            padding: 0 20px 20px;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transform: translateY(-10px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .search-suggestions.active {
            max-height: 300px;
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            position: relative;
            z-index: 100;
            overflow: visible;
        }

        .suggestion-group h4 {
            font-size: 14px;
            margin: 0 0 10px;
            opacity: 0.7;
            font-weight: 500;
        }

        .suggestion-group ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .suggestion-group li {
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: translateX(-10px);
        }

        .search-suggestions.active .suggestion-group li {
            opacity: 1;
            transform: translateX(0);
        }

        .suggestion-group li:nth-child(1) {
            transition-delay: 0.1s;
        }

        .suggestion-group li:nth-child(2) {
            transition-delay: 0.15s;
        }

        .suggestion-group li:nth-child(3) {
            transition-delay: 0.2s;
        }

        .suggestion-group li:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .suggestion-group li i {
            opacity: 0.7;
            font-size: 14px;
            transition: transform 0.3s ease;
        }

        .suggestion-group li:hover i {
            transform: scale(1.1);
        }


        @media (prefers-color-scheme: dark) {
            .glass-search {
                --bg-color: rgba(0, 0, 0, 0.25);
                --highlight: rgba(255, 255, 255, 0.15);
                --input-bg: rgba(0, 0, 0, 0.2);
                --input-border: rgba(255, 255, 255, 0.1);
                --input-focus: rgba(0, 0, 0, 0.3);
            }
        }

        #header-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            transition: all 0.3s ease;
            --bg-color: transparent !important;
            border-radius: 0 !important;
            border-left: none;
            border-right: none;
            border-top: none;
        }

        #header-bar .glass-content {
            display: flex;
            flex-direction: column;
        }

        #tab-bar {
            display: flex;
            transition: all 0.3s ease;
            height: 42px;
        }

        #tab-bar::-webkit-scrollbar,
        #tab-bar .glass-content::-webkit-scrollbar {
            height: 0;
            width: 0;
            display: none;
        }

        #tab-bar .glass-content {
            scrollbar-width: none;
        }

        .tab-item {
            cursor: pointer;
            user-select: none;
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 6px 6px 0 0;
            transition: all 0.2s ease;
        }

        .tab-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tab-close {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }


        body.tab-style-default #tab-bar {
            /* Handled by global sidebar styles */
        }

        body.tab-style-default #content-area {
            margin: 100px 10px 0 10px;
        }

        #nav-bar {
            height: 48px;
            padding: 0 16px;
            display: none;
            align-items: center;
            gap: 16px;
        }

        body.tab-style-default #nav-bar {
            display: flex;
        }

        .nav-controls {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .nav-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .nav-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        .address-bar-container {
            flex: 1;
            height: 34px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 17px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: border-color 0.2s ease, background 0.2s ease;
        }

        .address-bar-container:focus-within {
            border-color: rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
        }

        .lock-icon {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.4);
        }

        #address-bar {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #fff;
            font-size: 14px;
            width: 100%;
        }

        #address-bar::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        body.tab-style-default .tab-preview {
            display: none;
        }

        body.tab-style-default .tab-item {
            min-width: 120px;
            max-width: 200px;
            height: 34px;
            padding: 0 14px;
            margin-bottom: -1px;
            justify-content: space-between;
            background: transparent;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 6px 6px 0 0;
        }

        body.tab-style-default .tab-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            border-bottom: none;
        }

        body.tab-style-default .tab-item.active {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-bottom: none;
            border-radius: 4px 4px 0 0;
        }

        body.tab-style-default .tab-title {
            opacity: 1;
            transform: none;
            display: block;
            max-width: 140px;
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 0;
        }

        body.tab-style-default .tab-item.active .tab-title {
            color: #fff;
        }

        body.tab-style-default .tab-close {
            opacity: 0;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            transition: 0.2s;
            position: relative;
            right: auto;
            top: auto;
            transform: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.4);
        }

        body.tab-style-default .tab-item:hover .tab-close {
            opacity: 1;
        }

        body.tab-style-default .tab-close:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        body.tab-style-default #new-tab-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            margin-left: 8px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            opacity: 0.6;
            transition: all 0.2s ease;
        }

        body.tab-style-default #new-tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            opacity: 1;
        }


        body.tab-style-dots #header-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            pointer-events: none;
            z-index: 9000;
        }

        body.tab-style-dots .nav-glass-layer {
            display: block;
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
        }

        .nav-glass-layer {
            display: none;
        }

        body.tab-style-dots #nav-bar {
            /* Use dual sidebar layout by default */
        }

        body.tab-style-dots #nav-bar .address-bar-container {
            width: 300px;
            flex: none;
            height: 36px;
            border-radius: 18px;
        }

        body.tab-style-dots #nav-bar:hover {
            /* background: rgba(24, 24, 27, 0.95); */
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.4);
            transform: translateX(-50%) translateY(-2px);
        }

        body.tab-style-dots #header-bar .glass-content {
            background: transparent;
            box-shadow: none;
        }

        body.tab-style-dots #header-bar .glass-filter,
        body.tab-style-dots #header-bar .glass-overlay,
        body.tab-style-dots #header-bar .glass-specular {
            display: none;
        }

        body.tab-style-dots #tab-bar {
            justify-content: flex-start;
            align-items: center;
            opacity: 1;
            pointer-events: auto;
            transform: none;
        }

        .bottom-hover-zone {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 33.33%;
            height: 22px;
            z-index: 9005;
            background: transparent;
        }

        /* Interaction: Hover bottom zone -> Hide Nav Bar, Show Tab Bar */
        /* Interaction: Hover bottom zone removed for sidebar consistency */
        /*
        body.tab-style-dots:has(.bottom-hover-zone:hover) #nav-bar,
        body.tab-style-dots:has(#tab-bar:hover) #nav-bar {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-50%) translateY(10px);
        }

        body.tab-style-dots:has(.bottom-hover-zone:hover) #tab-bar,
        body.tab-style-dots #tab-bar:hover {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(0);
        }
        */

        body.tab-style-dots #content-area {
            margin: 10px 10px 0 10px;
        }

        body.tab-style-dots .tab-item {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            padding: 0;
            justify-content: center;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.2);
        }

        body.tab-style-dots .tab-item:hover,
        body.tab-style-dots .tab-item.active {
            width: 200px;
            height: 36px;
            border-radius: 24px;
            padding: 0 36px 0 14px;
            justify-content: flex-start;
            background: rgba(255, 255, 255, 0.08);
            transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), background-color 0.3s, padding 0.3s;
        }

        body.tab-style-dots .tab-item.active {
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.tab-style-dots .tab-title {
            display: block;
            opacity: 0;
            transform: translateX(-10px);
            color: #fff;
            font-size: 13px;
            pointer-events: none;
            transition: 0.2s;
            white-space: nowrap;
        }

        body.tab-style-dots .tab-item:hover .tab-title,
        body.tab-style-dots .tab-item.active .tab-title {
            opacity: 1;
            transform: none;
            pointer-events: auto;
        }

        body.tab-style-dots .tab-close {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%) scale(0.8);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            opacity: 0;
            background: transparent;
            color: rgba(255, 255, 255, 0.4);
        }

        body.tab-style-dots .tab-item:hover .tab-close,
        body.tab-style-dots .tab-item.active .tab-close {
            opacity: 1;
            transform: translateY(-50%) scale(1);
        }

        body.tab-style-dots .tab-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        body.tab-style-dots #new-tab-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-left: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }


        body.tab-style-vertical #tab-bar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 70px;
            flex-direction: column;
            padding: 20px 0;
            gap: 10px;
            background: rgba(24, 24, 27, 0.2);
            backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            align-items: center;
            justify-content: flex-start;
            border-radius: 0;
            transform: none;
            box-shadow: none;
            height: 100%;
            z-index: 2000;
        }

        body.tab-style-vertical .tab-title {
            position: static !important;
            left: auto !important;
            top: auto !important;
            transform: none !important;
            background: transparent !important;
            color: inherit !important;
            padding: 0 !important;
            border: none !important;
            border-radius: 0 !important;
            white-space: nowrap !important;
            display: block !important;
            width: auto !important;
            min-width: 0 !important;
            flex: 1 !important;
            opacity: 1 !important;
            transition: none !important;
            pointer-events: none !important;
            box-shadow: none !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            font-size: 13px !important;
            font-weight: 400 !important;
            line-height: 1 !important;
        }

        body.tab-style-vertical .tab-item.active .tab-title {
            font-weight: 500 !important;
        }

        body.tab-style-vertical .tab-item:hover .tab-title {
            /* Remove any hover overrides */
        }

        body.tab-style-vertical #content-area {
            margin: 10px 10px 0 80px;
        }

        body.tab-style-vertical .tab-item {
            /* Vertical sidebar handled by global styles */
        }

        body.tab-style-vertical .tab-item:hover,
        body.tab-style-vertical .tab-item.active {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.12);
            color: #fff;
            justify-content: center;
            padding: 0;
        }

        body.tab-style-vertical .tab-item.active {
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        body.tab-style-vertical #new-tab-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.4);
        }


        body.tab-style-radial #tab-bar {
            /* Radial style handled by transform overrides in JS */
        }

        body.tab-style-radial #content-area {
            margin: 10px 10px 0 10px;
        }

        body.tab-style-radial .tab-item {
            pointer-events: auto;
            position: absolute;
            bottom: 0;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        body.tab-style-radial .tab-item:hover,
        body.tab-style-radial .tab-item.active {
            transform: scale(1.2) translateY(-10px);
            z-index: 10;
            background: var(--bg-main);
            color: #fff;
        }

        body.tab-style-radial #new-tab-btn {
            position: absolute;
            bottom: 0;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
            z-index: 1001;
        }

        #content-area {
            flex: 1;
            position: relative;
            z-index: 50;
            overflow: hidden;
            margin: 10px 10px 0 10px;
            border-radius: 12px;
            background: transparent;
            display: flex;
            flex-direction: column;
        }

        .iframe-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            flex: 1;
            display: flex;
            background: transparent;
        }

        .tab-iframe {
            width: 100%;
            height: 100%;
            border: none;
            flex: 1;
        }

        .tab-content {
            width: 100%;
            height: 100%;
            display: none;
            background: transparent;
            border-radius: 12px;
            overflow: hidden;
        }

        .tab-content iframe {
            border: none;
        }

        .tab-content.app-internal {
            background: transparent;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            flex: 1;
        }

        #new-tab-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            margin: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
            color: rgba(255, 255, 255, 0.6);
            /* Ensure it stays below tabs in a flex column */
            order: 2;
        }

        #new-tab-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            transform: scale(1.1);
        }



        /* Dynamic Island Style */
        body.tab-style-dynamic #tab-bar {
            position: fixed;
            top: 20px;
            /* Moved to top */
            bottom: auto;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 9999;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            width: auto;
            max-width: 90vw;
            height: auto;
            overflow: visible;
        }

        body.tab-style-dynamic .tab-item {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            flex-shrink: 0;
            overflow: hidden;
        }

        body.tab-style-dynamic .tab-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        body.tab-style-dynamic .tab-item.active {
            width: auto;
            min-width: 120px;
            max-width: 200px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0 4px 0 12px;
            justify-content: flex-start;
        }

        body.tab-style-dynamic .tab-preview {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body.tab-style-dynamic .tab-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        body.tab-style-dynamic .tab-title {
            display: none;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-left: 8px;
            color: #fff;
            opacity: 0;
            transition: opacity 0.2s;
            flex: 1;
        }

        body.tab-style-dynamic .tab-item.active .tab-title {
            display: block;
            opacity: 1;
        }

        body.tab-style-dynamic .tab-close {
            display: none;
            margin-left: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            flex-shrink: 0;
        }

        body.tab-style-dynamic .tab-item.active .tab-close {
            display: flex;
        }

        body.tab-style-dynamic .tab-close:hover {
            background: #ef4444;
            color: white;
        }

        /* Round Add Button for Dynamic Style */
        body.tab-style-dynamic #new-tab-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
            margin-left: 0;
        }

        body.tab-style-dynamic #new-tab-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Integrated Nav Controls in Dynamic Island */
        body.tab-style-dynamic .nav-controls.integrated {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-right: 18px;
            padding-right: 12px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            height: 24px;
        }

        body.tab-style-dynamic .nav-controls.integrated .nav-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s;
        }

        body.tab-style-dynamic .nav-controls.integrated .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            transform: scale(1.1);
        }

        body.tab-style-dynamic .nav-controls.integrated .nav-btn i {
            width: 16px;
            height: 16px;
        }

        body.tab-style-vertical #tab-bar {
            overflow: visible;
        }

        body.tab-style-vertical .tab-item {
            overflow: visible;
        }

        body.tab-style-radial .tab-item:hover .tab-title {
            display: block !important;
            opacity: 1;
            bottom: 70px;
            background: #18181b;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 102;
            width: auto;
            white-space: nowrap;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.tab-style-radial .tab-close {
            display: flex;
            opacity: 0;
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        body.tab-style-radial .tab-item:hover .tab-close {
            opacity: 1;
            transform: scale(1);
        }

        body.tab-style-dots #tab-bar {
            bottom: 15px !important;
        }



        body.tab-style-vertical .tab-close {
            position: relative !important;
            top: auto !important;
            bottom: auto !important;
            right: auto !important;
            width: 18px !important;
            height: 18x !important;
            border-radius: 3px !important;
            background: transparent !important;
            color: rgba(255, 255, 255, 0.4) !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: background 0.15s ease, color 0.15s ease, opacity 0.15s ease;
            margin-left: auto;
            flex-shrink: 0;
        }

        body.tab-style-vertical .tab-item:hover .tab-close {
            opacity: 1;
        }

        body.tab-style-vertical .tab-close:hover {
            background: rgba(239, 68, 68, 0.15) !important;
            color: #ef4444 !important;
        }

        #loading-screen {
            position: fixed;
            inset: 0;
            background: #18181b;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 1s cubic-bezier(0.4, 0, 0.2, 1), filter 1s ease;
        }

        #loading-screen.fade-out {
            opacity: 0;
            pointer-events: none;
            filter: blur(20px);
        }

        #loading-canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
        }

        .loading-content {
            position: relative;
            z-index: 1;
            text-align: center;
            pointer-events: none;
        }

        .loading-brand {
            font-size: 3.5rem;
            font-weight: 600;
            letter-spacing: 0.5rem;
            color: #f4f4f5;
            text-transform: uppercase;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 2s ease, transform 2s ease, letter-spacing 2s ease;
        }

        .loading-brand.visible {
            opacity: 1;
            transform: translateY(0);
            letter-spacing: 0.8rem;
        }

        .loading-status {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #666;
            letter-spacing: 0.2rem;
            text-transform: uppercase;
            opacity: 0.6;
        }


        #settings-content::-webkit-scrollbar {
            width: 6px;
        }

        #settings-content::-webkit-scrollbar-track {
            background: transparent;
        }

        #settings-content::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        #settings-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }


        .version-tag {
            position: fixed;
            bottom: 20px;
            right: 30px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 2px;
            color: rgba(255, 255, 255, 0.15);
            text-transform: uppercase;
            pointer-events: none;
            z-index: 9999;
        }

        body.tab-style-default .version-tag {
            bottom: 20px;
        }

        body.tab-style-dots .version-tag,
        body.tab-style-radial .version-tag {
            bottom: 80px;
            right: 50%;
            transform: translateX(50%);
        }


        .custom-context-menu {
            position: fixed;
            background: #18181b;
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 6px;
            min-width: 180px;
            z-index: 999999;
            opacity: 0;
            transform: scale(0.95);
            transform-origin: top left;
            transition: opacity 0.15s ease, transform 0.15s ease;
            pointer-events: none;
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.05),
                0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .custom-context-menu.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .context-menu-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
        }

        .context-menu-divider {
            height: 1px;
            background: rgba(0, 0, 0, 0.05);
            margin: 6px 0;
        }


        .iframe-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .iframe-overlay {
            position: absolute;
            inset: 0;
            z-index: 10;
            cursor: pointer;
        }

        .iframe-overlay.hidden {
            display: none;
        }





        .notification-btn {
            position: fixed !important;
            --bg-color: transparent;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;

            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9999;
            color: rgba(255, 255, 255, 0.5);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .notification-btn:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            transform: scale(1.1);
            color: #fff;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #ef4444;
            color: #fff;
            font-size: 10px;
            font-weight: bold;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            border: 2px solid #fff;
        }

        .notification-badge.active {
            display: flex;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .spin-animation {
            animation: spin 0.5s ease-in-out;
        }

        body {
            background-color: #0d0d10;
        }

        #classic-load-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 3px;
            background: #ef4444;
            z-index: 1000;
            transition: width 0.3s ease-out, opacity 0.5s;
            pointer-events: none;
        }

        #classic-load-bar.loading {
            width: 60%;
            opacity: 1;
        }

        #classic-load-bar.finished {
            width: 100%;
            opacity: 0;
        }



        /* Onboarding Overlay Styles */
        #onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 10000;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #onboarding-overlay.active {
            display: block;
            opacity: 1;
        }

        .onboarding-highlight-gw {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 40px;
            background: linear-gradient(to top, rgba(16, 185, 129, 0.4), transparent);
            border-radius: 50% 50% 0 0;
            filter: blur(20px);
            animation: pulse-glow 2s infinite;
            pointer-events: none;
        }

        .onboarding-tooltip {
            position: absolute;
            background: rgba(24, 24, 27, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            pointer-events: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            transform: translateY(10px);
            max-width: 280px;
            text-align: center;
        }

        .onboarding-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .onboarding-tooltip::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }

        /* Tooltip Arrow - Bottom (pointing down) */
        .onboarding-tooltip.arrow-bottom::after {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px 6px 0 6px;
            border-color: rgba(24, 24, 27, 0.9) transparent transparent transparent;
        }

        /* Tooltip Arrow - Top (pointing up) */
        .onboarding-tooltip.arrow-top::after {
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 6px 6px 6px;
            border-color: transparent transparent rgba(24, 24, 27, 0.9) transparent;
        }

        @keyframes pulse-glow {
            0% {
                opacity: 0.3;
                transform: translateX(-50%) scaleX(0.9);
            }

            50% {
                opacity: 0.7;
                transform: translateX(-50%) scaleX(1.1);
            }

            100% {
                opacity: 0.3;
                transform: translateX(-50%) scaleX(0.9);
            }
        }

        .onboarding-step-1-pos {
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
        }

        .onboarding-step-1-pos.visible {
            transform: translateX(-50%) translateY(0);
        }

        .onboarding-step-2-pos {
            bottom: 100px;
            /* Adjusted to point to nav bar */
            left: 50%;
            transform: translateX(-50%) translateY(10px);
        }

        .onboarding-step-2-pos.visible {
            transform: translateX(-50%) translateY(0);
        }

        /* Dual Sidebar Layout Styles */
        #app-layout {
            display: flex;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: transparent;
        }

        #nav-sidebar {
            width: 72px;
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 0;
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            z-index: 10000;
            gap: 24px;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .nav-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .nav-icon:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .nav-icon.active {
            color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
        }

        #tab-bar {
            width: 260px;
            background: transparent;
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 16px;
            z-index: 9999;
            position: relative !important;
            transform: none !important;
            height: 100% !important;
            flex-shrink: 0;
            gap: 8px;
            box-shadow: none !important;
            border-radius: 0 !important;
            left: auto !important;
            bottom: auto !important;
            top: auto !important;
            justify-content: flex-start;
            position: relative;
        }

        #new-tab-btn {
            width: 100% !important;
            height: 44px !important;
            border-radius: 10px !important;
            background: rgba(255, 255, 255, 0.05) !important;
            color: rgba(255, 255, 255, 0.7) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: flex-start !important;
            padding: 0 16px !important;
            margin: 0 0 12px 0 !important;
            /* Spacing after button */
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
            flex-shrink: 0;
        }

        #new-tab-btn:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            color: #fff !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            transform: none !important;
        }

        .tab-item {
            width: 100% !important;
            height: 36px !important;
            display: flex !important;
            align-items: center !important;
            padding: 0 14px !important;
            border-radius: 8px !important;
            margin-bottom: 0 !important;
            background: transparent !important;
            border: none !important;
            border-top: 1px solid rgba(255, 255, 255, 0.05) !important;
            color: rgba(255, 255, 255, 0.6) !important;
            position: relative !important;
            transform: none !important;
            justify-content: flex-start !important;
            flex-shrink: 0;
            overflow: visible !important;
            transition: background 0.15s ease, color 0.15s ease !important;
            gap: 10px !important;
        }

        .tab-item:first-child {
            border-top: none !important;
        }

        .tab-item:hover {
            background: rgba(255, 255, 255, 0.05) !important;
            color: rgba(255, 255, 255, 0.9) !important;
        }

        .tab-item.active {
            background: rgba(255, 255, 255, 0.1) !important;
            color: #fff !important;
        }

        .tab-item .tab-preview {
            width: 16px !important;
            height: 16px !important;
            border-radius: 3px !important;
            margin-right: 0 !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            background: transparent !important;
            flex-shrink: 0;
        }

        .tab-item .tab-preview img,
        .tab-item .tab-preview i {
            width: 16px;
            height: 16px;
            object-fit: contain;
        }

        .tab-item .tab-preview img {
            border-radius: 2px;
        }

        .tab-item .tab-title {
            display: block !important;
            opacity: 1 !important;
            transform: none !important;
            font-size: 13px !important;
            font-weight: 400 !important;
            position: static !important;
            background: transparent !important;
            padding: 0 !important;
            border: none !important;
            box-shadow: none !important;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            pointer-events: none;
            line-height: 1 !important;
        }

        .tab-item.active .tab-title {
            font-weight: 500 !important;
        }

        .tab-item .tab-close {
            display: flex !important;
            position: relative !important;
            right: auto !important;
            top: auto !important;
            transform: none !important;
            opacity: 0;
            width: 20px !important;
            height: 20px !important;
            background: transparent !important;
            color: rgba(255, 255, 255, 0.4) !important;
            border-radius: 4px !important;
            justify-content: center;
            align-items: center;
            margin-left: auto;
            flex-shrink: 0;
        }

        .tab-item:hover .tab-close {
            opacity: 1 !important;
        }

        .tab-item .tab-close:hover {
            background: rgba(239, 68, 68, 0.2) !important;
            color: #ef4444 !important;
        }

        #main-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
            height: 100%;
            overflow: hidden;
            background: transparent;
            /* Main bg revealed */
        }

        #nav-bar {
            height: 64px !important;
            display: flex !important;
            align-items: center !important;
            padding: 0 24px !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08) !important;
            width: 100% !important;
            position: relative !important;
            transform: none !important;
            border-radius: 0 !important;
            background: transparent !important;
            /* Fully transparent */
            backdrop-filter: blur(20px);
            gap: 16px !important;
            box-shadow: none !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            z-index: 100 !important;
        }

        #nav-bar .address-bar-container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.2);
            height: 40px;
            border-radius: 10px;
        }

        #nav-bar .nav-controls {
            margin-right: 0 !important;
        }

        #content-area {
            flex: 1 !important;
            position: relative !important;
            margin: 0 !important;
            /* Remove margins */
            border-radius: 0 !important;
            overflow: hidden !important;
            background: transparent;
            /* Reveal vanta */
            z-index: 1;
        }

        /* Hide old decorations */
        .glass-surface,
        .glass-filter,
        .glass-specular,
        .glass-overlay {
            /* We might want to keep these for internal elements but hide for the main containers if they interfere */
        }

        #header-bar {
            display: none !important;
            /* Hide old header bar if it still exists */
        }

        /* Adjust loading bar position */
        #classic-load-bar {
            top: 64px !important;
            /* Below nav bar */
        }

        /* NUCLEAR DEBUG - IMPOSSIBLE TO MISS BORDER */
        body.tab-style-vertical #tab-bar {
            border-right: 5px solid #ff0000 !important;
            box-shadow: 5px 0 0 #00ff00 !important;
        }

        /* Also try on the parent */
        body.tab-style-vertical #tab-bar::after {
            content: '';
            position: absolute;
            right: -1px;
            top: 0;
            bottom: 0;
            width: 1px;
            background: #303030 !important;
            opacity: 0.5;
            z-index: 999999;
        }

        /* Hide scrollbar in tabs list */
        #tabs-list::-webkit-scrollbar {
            width: 0 !important;
            display: none !important;
        }

        #tabs-list {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }
    </style>
</head>

<body>
    <div id="auth-overlay">
        <div class="auth-modal auth-view" id="auth-view-login">
            <div class="auth-header">
                <div class="auth-title">welcome back</div>
                <div class="auth-subtitle">login to your account</div>
            </div>
            <div class="auth-error" style="display:none; color:#ef4444; text-align:center; margin-bottom:10px;"></div>
            <input type="text" class="auth-input" id="auth-login-user" placeholder="username"><input type="password"
                class="auth-input" id="auth-login-pass" placeholder="password"><button class="auth-btn"
                onclick="attemptLogin()">login</button>
            <div class="auth-link" onclick="switchAuthMode('signup')">create an account</div>
            <div class="auth-link" style="margin-top:8px; font-size:0.75rem; opacity:0.7" onclick="playAsGuest()">login
                as guest (unsaved)</div>
        </div>
        <div class="auth-modal auth-view" id="auth-view-signup" style="display:none;">
            <div class="auth-header">
                <div class="auth-title">create account</div>
                <div class="auth-subtitle">join lightlink</div>
            </div>
            <div class="auth-error" style="display:none; color:#ef4444; text-align:center; margin-bottom:10px;"></div>
            <input type="text" class="auth-input" id="auth-signup-user" placeholder="username (3-20 chars)"><input
                type="password" class="auth-input" id="auth-signup-pass" placeholder="password"><input type="email"
                class="auth-input" id="auth-signup-email" placeholder="email (optional for 2fa)"><button
                class="auth-btn" onclick="attemptSignup()">sign up</button>
            <div class="auth-link" onclick="switchAuthMode('login')">already have an account?</div>
        </div>
        <div class="auth-modal auth-view" id="auth-view-2fa" style="display:none;">
            <div class="auth-header">
                <div class="auth-title">security check</div>
                <div class="auth-subtitle">enter the code sent to your email</div>
            </div>
            <div class="auth-error" style="display:none; color:#ef4444; text-align:center; margin-bottom:10px;"></div>
            <input type="text" class="auth-input" id="auth-2fa-code" placeholder="123456" maxlength="6"
                style="text-align:center; letter-spacing:4px; font-size:1.5rem;"><button class="auth-btn"
                onclick="attempt2FA()">verify</button>
            <div class="auth-link" onclick="switchAuthMode('login')">back to login</div>
        </div>
    </div>
    <div id="tos-overlay">
        <div class="tos-modal">
            <div class="tos-header">
                <div class="tos-icon"><i data-lucide="file-text"></i></div>
                <h2 class="tos-title">Terms of Service</h2>
            </div>
            <div class="tos-content">
                <div class="tos-section">
                    <h4>1. Agreement to Terms</h4>
                    <p>These Terms of Service ("Terms") constitute a legally binding agreement between you ("User") and
                        the operators of Lightlink ("we," "us," or "the Service"). By accessing or using the Service,
                        you acknowledge that you have read,
                        understood,
                        and agree to be bound by these Terms. If you do not agree,
                        you must immediately discontinue use of the Service.</p>
                </div>
                <div class="tos-section">
                    <h4>2. Eligibility</h4>
                    <p>The Service is available to users of all ages. If you are under the age of 18 (or the age of
                        majority in your jurisdiction),
                        you represent that your parent or legal guardian has reviewed and agreed to these Terms on your
                        behalf. Continued use of the Service by a minor constitutes parental or guardian consent to the
                        collection,
                        use,
                        and disclosure of the minor's information
                        in accordance with these Terms.</p>
                </div>
                <div class="tos-section">
                    <h4>3. Description of Service</h4>
                    <p>Lightlink provides a web-based platform that may include,
                        but is not limited to,
                        web security services,
                        a user profiles system ("Profiles") enabling user-generated content and communication features,
                        activities,
                        and related services. You acknowledge that the Service is currently in a "Beta"
                        phase and may be subject to bugs,
                        errors,
                        and interruptions.</p>
                </div>
                <div class="tos-section">
                    <h4>4. User Conduct</h4>
                    <p>You agree not to use the Service to: (a) upload,
                        post,
                        or transmit any content that is unlawful,
                        harmful,
                        threatening,
                        abusive,
                        harassing,
                        defamatory,
                        obscene,
                        or otherwise objectionable;
                        (b) impersonate any person or entity;
                        (c) violate any applicable local,
                        state,
                        national,
                        or international law;
                        (d) engage in any activity that disrupts,
                        damages,
                        or interferes with the Service. We reserve the right to terminate or suspend your access
                        immediately,
                        without prior notice,
                        for any violation of these Terms.</p>
                </div>
                <div class="tos-section">
                    <h4>5. User-Generated Content</h4>
                    <p>The Profiles feature allows you to create profiles and communicate with other users. You are
                        solely responsible for all content you post,
                        upload,
                        or transmit ("User Content"). You retain ownership of your User Content,
                        but grant us a non-exclusive,
                        royalty-free,
                        worldwide license to use,
                        display,
                        and distribute such content in connection with the Service.</p>
                </div>
                <div class="tos-section">
                    <h4>6. Intellectual Property</h4>
                    <p>The Service and its original content (excluding User Content) are and will remain the exclusive
                        property of the operators. Our trademarks and trade dress may not be used without our prior
                        written consent. The Service is licensed under the GNU Affero General Public License v3.0
                        (AGPL-3.0).</p>
                </div>
                <div class="tos-section">
                    <h4>7. Disclaimer of Warranties</h4>
                    <p>THE SERVICE IS PROVIDED ON AN "AS IS" AND "AS AVAILABLE" BASIS,
                        WITHOUT WARRANTIES OF ANY KIND,
                        EITHER EXPRESS OR IMPLIED. WE EXPRESSLY DISCLAIM ALL WARRANTIES,
                        INCLUDING BUT NOT LIMITED TO,
                        IMPLIED WARRANTIES OF MERCHANTABILITY,
                        FITNESS FOR A PARTICULAR PURPOSE,
                        AND NON-INFRINGEMENT. WE DO NOT WARRANT THAT THE SERVICE WILL BE UNINTERRUPTED,
                        SECURE,
                        OR ERROR-FREE.</p>
                </div>
                <div class="tos-section">
                    <h4>8. Limitation of Liability</h4>
                    <p>TO THE FULLEST EXTENT PERMITTED BY APPLICABLE LAW,
                        IN NO EVENT SHALL THE OPERATORS,
                        THEIR AFFILIATES,
                        DIRECTORS,
                        EMPLOYEES,
                        OR LICENSORS BE LIABLE FOR ANY INDIRECT,
                        INCIDENTAL,
                        SPECIAL,
                        CONSEQUENTIAL,
                        OR PUNITIVE DAMAGES,
                        OR ANY LOSS OF PROFITS OR REVENUES,
                        WHETHER INCURRED DIRECTLY OR INDIRECTLY,
                        OR ANY LOSS OF DATA,
                        USE,
                        GOODWILL,
                        OR OTHER INTANGIBLE LOSSES,
                        RESULTING FROM YOUR USE OF THE SERVICE.</p>
                </div>
                <div class="tos-section">
                    <h4>9. Indemnification</h4>
                    <p>You agree to defend,
                        indemnify,
                        and hold harmless the operators and their licensees from and against any claims,
                        liabilities,
                        damages,
                        judgments,
                        awards,
                        losses,
                        costs,
                        expenses,
                        or fees arising out of or relating to your violation of these Terms or your use of the Service.
                    </p>
                </div>
                <div class="tos-section">
                    <h4>10. Modifications to Terms</h4>
                    <p>We reserve the right to modify these Terms at any time,
                        at our sole discretion. If we make material changes,
                        we will provide notice. Your continued use of the Service after such modifications will
                        constitute your acceptance of the revised Terms.</p>
                </div>
                <div class="tos-section">
                    <h4>11. Termination</h4>
                    <p>We may terminate or suspend your access to the Service immediately,
                        without prior notice or liability,
                        for any reason whatsoever,
                        including,
                        without limitation,
                        if you breach these Terms. </p>
                </div>
                <div class="tos-section">
                    <h4>12. Governing Law</h4>
                    <p>These Terms shall be governed and construed in accordance with the laws of the jurisdiction in
                        which the operators reside,
                        without regard to its conflict of law provisions.</p>
                </div>
            </div>
            <!-- Yo bruh did you make the TOS with ai? yuh -->
            <div class="tos-footer"><button class="tos-decline-btn" onclick="declineTOS()">decline</button><button
                    class="tos-accept-btn" onclick="acceptTOS()">accept</button></div>
        </div>
    </div>
    <div id="notification-overlay" onclick="toggleNotifications()"></div>
    <div id="notification-panel">
        <div class="notif-header">
            <h2>notifications</h2>
            <div class="notif-close" onclick="toggleNotifications()"><i data-lucide="x"></i></div>
        </div>
        <div class="notif-content" id="notif-content">
            <div class="notif-section">
                <h3>inbox</h3>
                <div id="inbox-container"></div>
            </div>
            <div class="notif-section" style="margin-top: 32px;">
                <h3>changelog</h3>
                <div id="changelog-container"></div>
            </div>
            <div class="notif-section" style="margin-top: 32px;">
                <h3>announcements</h3>
                <div id="announcements-container"></div>
            </div>
        </div>
    </div>
    <div class="custom-context-menu" id="custom-context-menu">
        <div class="context-menu-item" onclick="contextMenuAction('profiles')"><i
                data-lucide="user"></i><span>profiles</span></div>
        <div class="context-menu-item" onclick="contextMenuAction('settings')"><i
                data-lucide="settings"></i><span>settings</span></div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="contextMenuAction('newtab')"><i data-lucide="plus"></i><span>new
                tab</span></div>
    </div>
    <div id="loading-screen"><canvas id="loading-canvas"></canvas>
        <div class="loading-content">
            <div class="loading-brand" id="loading-brand">lightlink</div>
            <div class="loading-status">fetching user data...</div>
        </div>
    </div>
    <div class="site-ban-overlay" id="site-ban-overlay"><i data-lucide="ban" class="site-ban-icon"
            style="width:120px;height:120px;"></i>
        <div class="site-ban-title">access denied</div>
        <div class="site-ban-reason" id="site-ban-reason">you've been banned from lightlink
        </div>
        <div class="site-ban-info">contact admin@lightlink.space if you think its a mistake </div>
    </div>
    <div class="site-warning-overlay" id="site-warning-overlay">
        <div class="site-warning-box"><i data-lucide="triangle-alert" class="site-warning-icon"
                style="width:80px;height:80px;"></i>
            <div class="site-warning-title">you got warned</div>
            <div class="site-warning-message" id="site-warning-message">you got a warning from an admin </div><button
                class="site-warning-dismiss" onclick="dismissSiteWarning()">i understand</button>
        </div>
    </div>
    <!--  I also made the site ban and site warning with ai, prolly bc i was lazy idk i forgot -->
    <div id="cloak-overlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:99999; color:#fff; flex-direction:column; justify-content:center; align-items:center; cursor:pointer;">
        <h1 style="font-weight:300;">click anywhere to open in secure tab</h1>
    </div>
    <div id="offscreen-cloak" tabindex="-1"
        style="outline:none; display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#000; z-index:1000000; flex-direction:column;">
        <div id="cloak-click-catcher"
            style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:1000002; cursor:pointer;">
        </div><iframe id="cloak-iframe" style="width:100%; height:100%; border:none;"></iframe>
    </div>
    <div id="vanta-bg"></div>
    <div id="app-layout">
        <div id="nav-sidebar">
            <div class="glass-overlay"
                style="background: rgba(9, 9, 11, 0.9); position: absolute; inset: 0; pointer-events: none;"></div>
            <div class="glass-specular" style="position: absolute; inset: 0; pointer-events: none;"></div>
            <div class="glass-content"
                style="display:flex; flex-direction:column; align-items:center; width:100%; height:100%; gap:24px; padding-top:24px; position:relative; z-index:5;">
                <div class="nav-icon" title="home" onclick="tManager.addTab('newtab')"><i data-lucide="home"></i></div>
                <div class="nav-icon" title="apps" onclick="tManager.addTab('activities', null, 'activities')"><i
                        data-lucide="layout-grid"></i></div>
                <div class="nav-icon" title="messages"
                    onclick="tManager.addTab('app-iframe', '/profiles/', 'messages')">
                    <i data-lucide="message-square"></i>
                </div>
                <div style="flex:1"></div>
                <div class="nav-icon" title="notifications" onclick="toggleNotifications()"><i data-lucide="bell"></i>
                    <div class="notification-badge" id="notification-badge">0</div>
                </div>
                <div class="nav-icon" title="settings" onclick="openSettingsModal()"><i data-lucide="settings"></i>
                </div>
            </div>
        </div>
        <div id="tab-bar"
            style="overflow-y:auto; overflow-x:hidden; display:flex !important; flex-direction:column !important; justify-content:flex-start !important; height:100% !important;">
            <script>
                // NUCLEAR OPTION: Force layout regardless of style class
                (function () {
                    function forceTabOrder() {
                        const tabBar = document.getElementById('tab-bar');
                        const tabsList = document.getElementById('tabs-list');
                        const newTabBtn = document.getElementById('new-tab-btn');

                        // DEBUG LOGGING - Keep getting info if needed
                        if (Math.random() < 0.05) {
                            // console.log('Body Classes:', document.body.className);
                            // if (tabsList) console.log('Tabs List Styles:', window.getComputedStyle(tabsList).justifyContent);
                        }

                        if (tabBar && tabsList) {
                            // 1. CONTAINER LAYOUT (Force Top-Down & FIXED WIDTH)
                            tabBar.style.setProperty('flex-direction', 'column', 'important');
                            tabBar.style.setProperty('justify-content', 'flex-start', 'important');

                            // FORCE WIDTH IN JS (nuclear backup)
                            tabBar.style.setProperty('width', '240px', 'important');
                            tabBar.style.setProperty('min-width', '240px', 'important');
                            tabBar.style.setProperty('max-width', '240px', 'important');
                            tabBar.style.setProperty('flex', '0 0 240px', 'important');

                            // NO BACKGROUND ENFORCEMENT
                            tabBar.style.setProperty('background', 'transparent', 'important');
                            tabBar.style.setProperty('backdrop-filter', 'none', 'important');
                            tabBar.style.setProperty('border-right', 'none', 'important');
                            tabBar.style.setProperty('box-shadow', 'none', 'important');
                            tabBar.style.setProperty('z-index', '100', 'important');

                            // 1b. CLEANUP OLD SEPARATORS
                            const oldSep = document.getElementById('v-sidebar-separator');
                            if (oldSep) oldSep.remove();

                            tabsList.style.setProperty('flex-direction', 'column', 'important');
                            tabsList.style.setProperty('justify-content', 'flex-start', 'important');
                            tabsList.style.setProperty('margin-top', '0', 'important');
                            tabsList.style.setProperty('margin-bottom', 'auto', 'important');
                            tabsList.style.setProperty('height', 'auto', 'important');
                            tabsList.style.setProperty('min-height', '0', 'important'); // Prevent full height forcing bottom align

                            // 2. NEW TAB BUTTON (Force to End)
                            if (newTabBtn) {
                                newTabBtn.style.setProperty('order', '99999', 'important');
                                newTabBtn.style.setProperty('margin-top', '8px', 'important');
                                newTabBtn.style.setProperty('flex-grow', '0', 'important'); // Don't expand
                            }

                            // Remove borders and indices
                            if (tabsList) tabsList.style.border = 'none';

                            // KILL GLASS OVERLAYS MANUALLY
                            if (tabBar) {
                                const overlays = tabBar.querySelectorAll('.glass-overlay, .glass-specular');
                                overlays.forEach(el => {
                                    el.style.setProperty('display', 'none', 'important');
                                    el.style.setProperty('opacity', '0', 'important');
                                });
                            }

                            // 3. TARGET ACTUAL PARENT (Since tabs-list is empty)
                            const oneTab = document.querySelector('.tab-item');
                            if (oneTab) {
                                const realParent = oneTab.parentElement;
                                if (realParent) {
                                    // Remove debug border
                                    realParent.style.border = 'none';

                                    // FORCE LAYOUT ON REAL PARENT - REVERTED TO SAFE STATE
                                    realParent.style.setProperty('display', 'flex', 'important');
                                    realParent.style.setProperty('flex-direction', 'column', 'important');
                                    realParent.style.setProperty('justify-content', 'flex-start', 'important');
                                    realParent.style.setProperty('margin-top', '0', 'important');
                                    realParent.style.setProperty('margin-bottom', 'auto', 'important'); // Safe auto

                                    // REVERT HEIGHT - Back to auto
                                    realParent.style.setProperty('flex-grow', '0', 'important');
                                    realParent.style.setProperty('min-height', '0', 'important');
                                    realParent.style.setProperty('height', 'auto', 'important');
                                    // realParent.style.setProperty('width', '100%', 'important'); // DO NOT FORCE WIDTH - let container decide
                                    realParent.style.setProperty('overflow-y', 'auto', 'important');

                                    // DEBUG: Find the SIDEBAR (Grandparent?)
                                    // if (Math.random() < 0.01) {
                                    //    console.log('Real Parent:', realParent.id, realParent.className);
                                    //    if(realParent.parentElement) console.log('Grandparent:', realParent.parentElement.id, realParent.parentElement.className);
                                    // }

                                    // Temporary Fix: If the USER wants a full background, maybe we apply it to the PARENT of this container?
                                    if (realParent.parentElement) {
                                        // Attempt to style the sidebar container instead
                                        // realParent.parentElement.style.background = ...
                                    }

                                    // Log what this parent is so we can fix background properly later
                                    // console.log('Real Tab Parent:', realParent.tagName, realParent.className, realParent.id);

                                    // To fix background, let's try to find the SIDEBAR explicitly and style it?
                                    // wrapper -> sidebar?
                                    // For now, just get the tabs back.

                                    // Ensure background covers the area (if that's the issue)
                                    // We force it to be transparent so the sidebar color shows through, OR same as sidebar
                                    // Assuming the user wants uniformity.
                                    // realParent.style.background = 'transparent'; 

                                    // If the user sees a "box", it might be a border or specific bg on this element.
                                    // Let's ensure it doesn't have a weird border/bg constraint.
                                    realParent.style.boxShadow = 'none';
                                    realParent.style.borderRadius = '0';

                                    // Log what this parent is so we can fix background properly later
                                    // console.log('Real Tab Parent:', realParent.tagName, realParent.className, realParent.id);

                                    // To fix background, let's try to find the SIDEBAR explicitly and style it?
                                    // wrapper -> sidebar?
                                    // For now, just get the tabs back.

                                    // Clean up its children
                                    let tabIndex = 1;
                                    Array.from(realParent.children).forEach(child => {
                                        child.style.setProperty('flex-grow', '0', 'important');
                                        child.style.setProperty('flex-shrink', '0', 'important');
                                        child.style.setProperty('margin-top', '0', 'important');
                                        child.style.setProperty('margin-bottom', '8px', 'important');

                                        if (child.classList.contains('tab-item')) {
                                            child.style.setProperty('position', 'relative', 'important');
                                            child.style.setProperty('order', tabIndex.toString(), 'important');
                                            child.style.setProperty('display', 'flex', 'important');

                                            // REMOVE DEBUG INDEX
                                            const titleEl = child.querySelector('.tab-title');
                                            if (titleEl && titleEl.innerText.startsWith('[')) {
                                                // Remove [1] ...
                                                titleEl.innerText = titleEl.innerText.replace(/^\[\d+\]\s*/, '');
                                            }
                                            tabIndex++;
                                        }
                                        else if (child.id === 'new-tab-btn') {
                                            child.style.setProperty('order', '99999', 'important');
                                            child.style.setProperty('margin-top', '16px', 'important'); // Aligned with CSS
                                            child.style.setProperty('padding-top', '0', 'important'); // Using height + flex for vertical centering
                                            child.style.setProperty('position', 'relative', 'important');

                                            // LOCK DIMENSIONS (No Jumping)
                                            child.style.setProperty('width', '100%', 'important');
                                            child.style.setProperty('height', '48px', 'important');
                                            child.style.setProperty('min-height', '48px', 'important');
                                            child.style.setProperty('max-height', '48px', 'important');
                                            child.style.setProperty('margin-left', '0', 'important');
                                            child.style.setProperty('margin-right', '0', 'important');
                                            child.style.setProperty('border-radius', '8px', 'important');
                                            child.style.setProperty('box-sizing', 'border-box', 'important');

                                            // FORCE CENTERED FLEX
                                            child.style.setProperty('display', 'flex', 'important');
                                            child.style.setProperty('justify-content', 'center', 'important');
                                            child.style.setProperty('align-items', 'center', 'important');
                                            child.style.setProperty('gap', '8px', 'important');

                                            // Make it an ACTUAL BUTTON (Opaque-ish)
                                            child.style.setProperty('background', 'rgba(255, 255, 255, 0.05)', 'important');
                                            child.style.setProperty('border', '1px solid rgba(255, 255, 255, 0.1)', 'important');
                                            child.style.setProperty('transition', 'background 0.2s ease, border-color 0.2s ease', 'important');

                                            // Fix Inner Elements for Centering (NUCLEAR STRIP)
                                            Array.from(child.children).forEach(inner => {
                                                // Remove all inline styles that might interfere (like margin-left: 8px)
                                                inner.removeAttribute('style');
                                                inner.style.setProperty('margin', '0', 'important');
                                                inner.style.setProperty('padding', '0', 'important');

                                                if (inner.tagName === 'SPAN') {
                                                    inner.style.setProperty('line-height', '1', 'important');
                                                }
                                            });

                                            // REMOVE Inner Separator if it exists
                                            let sep = document.getElementById('new-tab-separator');
                                            if (sep) sep.remove();

                                            // Remove old border attempts
                                            child.style.removeProperty('border-top');
                                            child.style.setProperty('border-top', 'none', 'important');
                                            child.style.setProperty('transform', 'none', 'important');
                                        }
                                    });
                                }
                            }
                        }
                    }

                    // Run furiously to override animations
                    forceTabOrder();
                    setInterval(forceTabOrder, 100);

                    const observer = new MutationObserver(forceTabOrder);
                    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
                    if (document.getElementById('tabs-list')) {
                        const listObserver = new MutationObserver(forceTabOrder);
                        listObserver.observe(document.getElementById('tabs-list'), { childList: true, subtree: true });
                    }
                })();
            </script>
            <style>
                /* FORCE OVERRIDES for Tab Layout */
                #tabs-list .tab-item,
                #tabs-list #new-tab-btn {
                    position: relative !important;
                    bottom: auto !important;
                    left: auto !important;
                    right: auto !important;
                    top: auto !important;
                    transform: none !important;
                    margin-bottom: 8px !important;
                    flex-shrink: 0 !important;
                    width: 100% !important;
                    max-width: 100% !important;
                    display: flex !important;
                }

                #tabs-list {
                    padding-bottom: 60px !important;
                    /* Space for scrolling */
                }

                /* SPECIFIC FIX FOR VERTICAL TABS */
                body.tab-style-vertical #tab-bar,
                body[class*="tab-style-vertical"] #tab-bar {
                    justify-content: flex-start !important;
                    flex-direction: column !important;

                    /* SIDEBAR DIMENSIONS - STRICT */
                    width: 260px !important;
                    min-width: 260px !important;
                    max-width: 260px !important;
                    flex: 0 0 260px !important;

                    /* HEIGHT - FORCE 100% VIEWPORT */
                    min-height: 100vh !important;
                    max-height: none !important;
                    overflow-y: auto !important;

                    /* BACKGROUND WITH BORDER */
                    background: transparent !important;
                    backdrop-filter: none !important;
                    z-index: 100 !important;
                    position: relative !important;
                    overflow: visible !important;
                    visibility: visible !important;
                    opacity: 1 !important;

                    /* VISIBLE BORDER - FINAL */
                    border-right: 2px solid rgba(255, 255, 255, 0.3) !important;
                    box-shadow: none !important;
                }

                /* Ensure inner content fills height too */
                body.tab-style-vertical #tab-bar .glass-content {
                    height: 100% !important;
                    min-height: 100% !important;
                    display: flex !important;
                    flex-direction: column !important;
                }

                body.tab-style-vertical #tabs-list,
                body[class*="tab-style-vertical"] #tabs-list {
                    justify-content: flex-start !important;
                    flex-direction: column !important;
                    margin-top: 0 !important;
                    margin-bottom: auto !important;

                    /* List doesn't need to be full height, just transparent */
                    height: auto !important;
                    min-height: 0 !important;

                    /* CLEANUP INNER LAYOUT */
                    width: 100% !important;
                    background: transparent !important;
                    box-shadow: none !important;
                    border: none !important;
                    backdrop-filter: none !important;
                    padding-bottom: 20px !important;
                }

                /* Ensure button is at the end with a separator line using pseudo-element for better visibility */
                body.tab-style-vertical #tabs-list #new-tab-btn {
                    order: 9999 !important;
                    margin-top: 16px !important;
                    padding: 0 !important;
                    /* Managed by fixed height + flex center */

                    width: 100% !important;
                    height: 48px !important;
                    min-height: 48px !important;
                    max-height: 48px !important;
                    margin-left: 0 !important;
                    margin-right: 0 !important;
                    box-sizing: border-box !important;

                    position: relative !important;
                    border-radius: 8px !important;
                    border: 1px solid rgba(255, 255, 255, 0.1) !important;
                    background: rgba(255, 255, 255, 0.05) !important;
                    transition: background 0.2s ease, border-color 0.2s ease !important;

                    display: flex !important;
                    justify-content: center !important;
                    align-items: center !important;
                    gap: 8px !important;
                    transform: none !important;
                }

                body.tab-style-vertical #tabs-list #new-tab-btn:hover {
                    background: rgba(255, 255, 255, 0.1) !important;
                    border-color: rgba(255, 255, 255, 0.2) !important;
                    transform: none !important;
                }

                /* FORCE ALL INNER ELEMENTS TO BEHAVE (NUCLEAR) */
                body.tab-style-vertical #tabs-list #new-tab-btn>* {
                    margin: 0 !important;
                    padding: 0 !important;
                    display: inline-flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    pointer-events: none !important;
                }

                body.tab-style-vertical #tabs-list #new-tab-btn span {
                    line-height: 1 !important;
                }

                /* Full Width Separator via Pseudo-element */
                body.tab-style-vertical #tabs-list #new-tab-btn::before {
                    content: '' !important;
                    position: absolute !important;
                    display: block !important;
                    top: -16px !important;
                    height: 1px !important;
                    left: -32px !important;
                    width: calc(100% + 64px) !important;
                    background: rgba(255, 255, 255, 0.1) !important;
                    pointer-events: none !important;
                }


                /* KILL THE BACKGROUND OVERLAYS */
                body.tab-style-vertical #tab-bar .glass-overlay,
                body.tab-style-vertical #tab-bar .glass-specular,
                body[class*="tab-style-vertical"] #tab-bar .glass-overlay,
                body[class*="tab-style-vertical"] #tab-bar .glass-specular {
                    display: none !important;
                    background: transparent !important;
                    opacity: 0 !important;
                }

                /* REVEAL THE VERTICAL SEPARATOR LINE (INDESTRUCTIBLE SMART SEP) */
                #v-smart-separator {
                    position: fixed !important;
                    top: 0 !important;
                    bottom: 0 !important;
                    width: 1px !important;
                    background: rgba(255, 255, 255, 0.2) !important;
                    z-index: 9999999999999 !important;
                    pointer-events: none !important;
                    display: none !important;
                    opacity: 0 !important;
                    transition: opacity 0.2s ease !important;
                }

                /* Show separator when in vertical mode */
                body.tab-style-vertical #v-smart-separator {
                    display: block !important;
                    opacity: 1 !important;
                }

                /* Backup for any body class containing 'vertical' */
                body[class*="tab-style-vertical"] #v-smart-separator,
                body.tab-style-vertical #v-smart-separator {
                    display: block !important;
                    opacity: 1 !important;
                }

                body.tab-style-vertical #main-content-wrapper {
                    border-left: none !important;
                }

                /* Fix tabs-list to show all tabs */
                body.tab-style-vertical #tabs-list {
                    flex: 1 1 auto !important;
                    height: auto !important;
                    min-height: 0 !important;
                    max-height: none !important;
                    overflow: visible !important;
                    display: flex !important;
                    flex-direction: column !important;
                }

                /* Make glass-content fill the tab-bar */
                body.tab-style-vertical #tab-bar .glass-content {
                    flex: 1 1 auto !important;
                    height: 100% !important;
                    display: flex !important;
                    flex-direction: column !important;
                }
            </style>
            <div class="glass-overlay"
                style="background: rgba(24, 24, 27, 0.4); position: absolute; inset: 0; pointer-events: none;"></div>
            <div class="glass-specular" style="position: absolute; inset: 0; pointer-events: none;"></div>
            <div class="glass-content"
                style="display:flex !important; flex-direction:column !important; width:100%; height:100%; padding:16px; gap:8px; position:relative; z-index:5; justify-content: flex-start !important;">
                <div id="tabs-list"
                    style="display:flex !important; flex-direction:column !important; gap:3px !important; justify-content: flex-start !important; margin: 0 !important; width: 100% !important; flex: 1 1 auto !important; overflow: visible !important; min-height: 0 !important; height: auto !important;">
                    <!-- Tabs will be injected here by TabManager -->
                    <div id="new-tab-btn" onclick="tManager.addTab('newtab')"><i data-lucide="plus"></i><span
                            style="font-size:14px; font-weight:500; margin-left:8px;">new tab</span></div>
                </div>
            </div>
        </div>
        <div id="main-content-wrapper">
            <div id="nav-bar">
                <div id="classic-load-bar"></div>
                <div class="glass-overlay nav-glass-layer"></div>
                <div class="glass-specular nav-glass-layer"></div>
                <div class="nav-controls" style="z-index:5; position:relative;">
                    <div class="nav-btn" id="nav-back" onclick="navPillAction('back')" title="go back"><i
                            data-lucide="arrow-left"></i></div>
                    <div class="nav-btn" id="nav-forward" onclick="navPillAction('forward')" title="go forward"><i
                            data-lucide="arrow-right"></i></div>
                    <div class="nav-btn" id="nav-reload" onclick="navPillAction('reload')" title="reload"><i
                            data-lucide="rotate-cw"></i></div>
                </div>
                <div class="address-bar-container" style="position: relative; z-index:5;">
                    <i data-lucide="lock" class="lock-icon" onclick="togglePrivacyModal(event)"
                        style="cursor: pointer;"></i>
                    <input type="text" id="address-bar" placeholder="search" spellcheck="false" autocomplete="off">

                    <div id="privacy-popover" onclick="event.stopPropagation()">
                        <div class="privacy-popover-content">
                            <div class="privacy-header-small">
                                <i data-lucide="shield-check" style="color: #10b981; margin-right: 8px;"></i>
                                <span style="font-weight: 600; font-size: 0.9rem;">lightlink's privacy truly hides
                                    you</span>
                            </div>
                            <div class="privacy-body-small">
                                <p>at lightlink, we value your privacy to the highest standards possible. we encrypt
                                    urls sent by you, ensure end to end encryption, and do not collect any data from
                                    you. while we do not collect data from you, we also do not ensure that data is
                                    completely private, as we rely on third party search engines, which are known to be
                                    reliable and made for security, but there is no guarantee that data is completely
                                    private on their end, and although all requests go through us, we are not
                                    responsible for their privacy policies. </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="content-area"></div>
        </div>
    </div>
    <div class="bottom-hover-zone"></div>
    <div id="settings-modal">
        <div class="modal-close" onclick="closeSettingsModal()"><i data-lucide="x"></i></div>
        <div id="settings-content" style="width:100%; height:100%;"></div>
    </div>
    <div id="settings-glass-bg"></div>
    <script>(function () {
            const originalAddEventListener = window.addEventListener;

            window.addEventListener = function (type, listener, options) {
                if (type === 'deviceorientation' || type === 'devicemotion') {
                    return;
                }

                return originalAddEventListener.call(this, type, listener, options);
            }

                ;
        })();
    </script><svg style="position: absolute; width: 0; height: 0; pointer-events: none;"
        xmlns="http://www.w3.org/2000/svg">
        <defs>
            <filter id="goo">
                <feGaussianBlur id="SvgjsFeGaussianBlur1000" result="SvgjsFeGaussianBlur1000" in="SourceGraphic"
                    stdDeviation="2"></feGaussianBlur>
                <feColorMatrix id="SvgjsFeColorMatrix1001" result="SvgjsFeColorMatrix1001" in="SvgjsFeGaussianBlur1000"
                    values="
 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 16 -10 " type="matrix"></feColorMatrix>
                <feComposite id="SvgjsFeComposite1002" result="SvgjsFeComposite1002" in="SvgjsFeColorMatrix1001"
                    operator="atop"></feComposite>
            </filter>
            <filter id="knockout" colorInterpolationFilters="sRGB">
                <feColorMatrix result="knocked" type="matrix" values="1 0 0 0 0
 0 1 0 0 0 0 0 1 0 0 -1 -1 -1 1 0" />
                <feComponentTransfer>
                    <feFuncR type="linear" slope="3" intercept="-1" />
                    <feFuncG type="linear" slope="3" intercept="-1" />
                    <feFuncB type="linear" slope="3" intercept="-1" />
                </feComponentTransfer>
                <feComponentTransfer>
                    <feFuncR type="table" tableValues="0 0 0 0 0 1 1 1 1 1" />
                    <feFuncG type="table" tableValues="0 0 0 0 0 1 1 1 1 1" />
                    <feFuncB type="table" tableValues="0 0 0 0 0 1 1 1 1 1" />
                </feComponentTransfer>
            </filter>
            <filter id="remove-black" color-interpolation-filters="sRGB">
                <feColorMatrix type="matrix" values="1 0 0 0 0
 0 1 0 0 0 0 0 1 0 0 -1000 -1000 -1000 0 1" result=" black-pixels" />
                <feComposite in="SourceGraphic" in2="black-pixels" operator="out" />
            </filter>
        </defs>
    </svg><svg style="position: absolute; width: 0; height: 0; overflow: hidden; pointer-events: none;">
        <filter id="glass-distortion">
            <feTurbulence type="turbulence" baseFrequency="0.012" numOctaves="3" result="noise" />
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="22" />
        </filter>
    </svg>
    <script>(function () {
            const originalAddEventListener = window.addEventListener;

            window.addEventListener = function (type, listener, options) {
                if (type === 'deviceorientation' || type === 'devicemotion') {
                    return;
                }

                return originalAddEventListener.call(this, type, listener, options);
            }

                ;
        })();

    </script>
    <script>(function () {
            const style = 'vertical';
            document.body.classList.add('tab-style-' + style);

            window.updateRadialLayout = function () {
                if (!document.body.classList.contains('tab-style-radial')) return;
                const tabs = document.querySelectorAll('.tab-item');
                const total = tabs.length;
                const arcDeg = 80;
                const startAngle = -arcDeg / 2;
                const step = total > 1 ? arcDeg / (total - 1) : 0;

                tabs.forEach((tab, index) => {
                    const angle = total > 1 ? startAngle + (index * step) : 0;
                    tab.style.transformOrigin = 'center 260px';

                    tab.style.transform = `rotate(${angle}deg)`;
                    tab.style.zIndex = index + 10;
                    tab.style.bottom = '40px';
                });
            }

                ;

            window.updateTabLayoutStyle = function (newStyle) {
                // Force vertical regardless of what is passed
                newStyle = 'vertical';
                document.body.className = document.body.className.replace(/tab-style-[\w-]+/g, '').trim();

                document.body.classList.add(`tab-style-${newStyle}`);
                localStorage.setItem('light-tab-style', newStyle);

                if (newStyle !== 'radial') {
                    document.querySelectorAll('.tab-item').forEach(t => {
                        t.style.transform = '';
                        t.style.bottom = '';
                        t.style.zIndex = '';
                        t.style.transformOrigin = '';
                    });
                }

                if (newStyle === 'radial' && window.updateRadialLayout) window.updateRadialLayout();
            }

                ;
        })();


        window.loadRemixIcon = function () {
            // Deprecated: RemixIcon replaced with Lucide
        }

            ;


        window.loadSocketIO = function () {
            return Promise.resolve();
        }

            ;


        window.autoCreateProfile = function () {
            if (localStorage.getItem('void_username')) return;

            if (typeof io === 'undefined') {

                return;
            }

            try {
                const socket = io({

                    path: '/profiles/socket.io/',
                    auth: {
                        username: null
                    }

                    ,
                    transports: ['websocket'],
                });

                socket.on('init', (data) => {
                    if (data.username) {
                        localStorage.setItem('void_username', data.username);

                    }

                    socket.disconnect();
                });

                socket.on('connect_error', () => {
                    socket.disconnect();
                });

                setTimeout(() => socket.disconnect(), 5000);
            }

            catch (e) { }
        }

            ;


        (async function checkBan() {
            try {
                const res = await fetch('/profiles/math/check-ban');
                const data = await res.json();

                if (data.banned) {
                    document.getElementById('site-ban-reason').textContent = data.reason || 'You have been banned from lightlink.';
                    document.getElementById('site-ban-overlay').classList.add('active');
                    document.body.style.overflow = 'hidden';
                    const allElements = document.body.querySelectorAll(':scope > *:not(#site-ban-overlay):not(script)');
                    allElements.forEach(el => el.style.display = 'none');
                }
            }

            catch (e) { }
        })();


        function dismissSiteWarning() {
            document.getElementById('site-warning-overlay').classList.remove('active');
        }

        (async function checkWarning() {
            const username = localStorage.getItem('void_username');
            if (!username) return;

            try {
                const res = await fetch(`/profiles/math/check-warning?username=${encodeURIComponent(username)}

                        `);
                const data = await res.json();

                if (data.warned) {
                    document.getElementById('site-warning-message').textContent = data.message || 'You have received a warning from an administrator.';
                    document.getElementById('site-warning-overlay').classList.add('active');
                }
            }

            catch (e) { }
        })();

        setInterval(async () => {
            const username = localStorage.getItem('void_username');
            if (!username) return;

            try {
                const res = await fetch(`/profiles/math/check-warning?username=${encodeURIComponent(username)}`);
                const data = await res.json();

                if (data.warned) {
                    document.getElementById('site-warning-message').textContent = data.message || 'You have received a warning from an administrator.';
                    document.getElementById('site-warning-overlay').classList.add('active');
                }
            }

            catch (e) { }
        }

            , 30000);


        window.openSecureTab = function () {
            try {
                const win = window.open('about:blank', '_blank');

                if (win) {
                    win.document.title = 'classroom.google.com';
                    win.document.body.style.margin = '0';
                    win.document.body.style.height = '100vh';
                    const iframe = win.document.createElement('iframe');
                    iframe.title = 'classroom.google.com';
                    iframe.allow = 'fullscreen; autoplay; clipboard-write; encrypted-media; picture-in-picture';
                    iframe.style.border = 'none';
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.margin = '0';
                    iframe.src = window.location.href;
                    win.document.body.appendChild(iframe);
                    window.location.href = 'https://classroom.google.com';
                }
            }

            catch (e) {
                alert('Pop-up blocked! Please allow pop-ups for this site.');
            }
        }

            ;
    </script>
    <script>let wispPromise = null;

        async function getWorkingWisp() {
            return "";
        }

        function waitForBareMux() {
            return new Promise((resolve) => {
                if (window.BareMux) return resolve();

                const interval = setInterval(() => {
                    if (window.BareMux) {
                        clearInterval(interval);
                        resolve();
                    }
                }, 100);

                setTimeout(() => {
                    clearInterval(interval);
                    resolve();
                }

                    , 5000);
            });
        }

        window.getProxyUrl = function (targetUrl) {
            if (window.scramjet && window.scramjet.encodeUrl) {
                return window.scramjet.encodeUrl(targetUrl);
            }

            return targetUrl;
        }

            ;

        async function registerSW() {
            if (!('serviceWorker' in navigator)) return;

            try {

                await waitForBareMux();
                if (!window.BareMux) throw new Error('BareMux library failed to load');

                const connection = new BareMux.BareMuxConnection("/baremux/worker.js");

                const transport = "/epoxy/index.mjs";
                const wispUrl = (location.protocol === "https:" ? "wss://" : "ws://") + "localhost:1103" + "/wisp/";

                const options = {
                    wisp: wispUrl
                }

                    ;
                const transportPromise = (await connection.getTransport()) !== transport ? connection.setTransport(transport, [options]) : Promise.resolve();

                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('BareMux Transport Timeout')), 5000));
                await Promise.race([transportPromise, timeoutPromise]);

                const type = localStorage.getItem('light-nav-transport') || 'astronomy';
                let registration;

                if (type === 'literature' && window.__literature$config) {
                    registration = await navigator.serviceWorker.register('/sw-literature.js', {
                        scope: '/'
                    });

                }

                else {
                    registration = await navigator.serviceWorker.register('/sw-astronomy.js', {
                        scope: '/',
                        type: 'module'
                    });
                }

                if (registration.installing) {
                    await new Promise((resolve) => {
                        registration.installing.addEventListener('statechange', (e) => {
                            if (e.target.state === 'activated') resolve();
                        });
                    });
                }

                if (!navigator.serviceWorker.controller) {
                    await new Promise((resolve) => {
                        const timeout = setTimeout(resolve, 2000);

                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            clearTimeout(timeout);
                            resolve();
                        }

                            , {
                                once: true
                            });
                    });
                }


            }

            catch (err) { }
        }

        // Initialize controller promise early so other components can wait for it
        window.controllerReadyPromise = new Promise(resolve => window.resolveControllerReady = resolve);
        window.proxyReady = window.controllerReadyPromise;

        window.switchTransport = async (transportType) => {
            try {
                const connection = new BareMux.BareMuxConnection("/baremux/worker.js");
                const transport = "/epoxy/index.mjs";
                const wispUrl = (location.protocol === "https:" ? "wss://" : "ws://") + "localhost:1103" + "/wisp/";

                const options = {
                    wisp: wispUrl
                }

                    ;
                await connection.setTransport(transport, [options]);
                localStorage.setItem('light-proxy-transport', transportType);

                try { }

                catch (e) { }
            }

            catch (e) { }
        }

            ;

    </script>
    <script>const CHANGELOG = [{
            version: '1.1',
            title: 'UI Updates and Closed Source',
            desc: 'Lightlink has officially updated to a newer, better, and safer version for your needs. What we fixed this update was removing ads, closing the source, changing the UI, making bugs less prevalent. We recommend you stay up to date for less for your safety and privacy.',
            date: 'Feb 8, 2026'
        }

            ,
        {
            version: '1.0',
            title: 'Release ',
            desc: 'Lightlink is officialy avaliable for everyone, and out of its early beta. We have now implimented a new authentication system for profiles, a quick update to the ui, performance updates and improvements, more security features, and more. To view the full changelog, please visit the Discord server.',
            date: 'Jan 7, 2026'
        }

        ];

        function toggleNotifications() {
            const panel = document.getElementById('notification-panel');
            const overlay = document.getElementById('notification-overlay');
            const isActive = panel.classList.toggle('active');
            overlay.classList.toggle('active', isActive);

            if (isActive) {
                renderNotifications();
                localStorage.setItem('light-last-read-notif', Date.now());
                updateBadge();
            }
        }

        async function renderNotifications() {
            const clContainer = document.getElementById('changelog-container');
            const annContainer = document.getElementById('announcements-container');
            const inboxContainer = document.getElementById('inbox-container');

            clContainer.innerHTML = CHANGELOG.map(item => ` <div class="notif-item" > <span class="changelog-tag" >Update</span> <div class="title" >${item.title}

                </div> <div class="desc" >${item.desc}

                </div> <div class="date" >${item.date}

                </div> </div> `).join('');

            if (inboxContainer) {
                if (USER_NOTIFICATIONS.length > 0) {
                    inboxContainer.parentElement.style.display = 'block';

                    inboxContainer.innerHTML = USER_NOTIFICATIONS.map(n => ` <div class="notif-item" style="position:relative;" > <span class="changelog-tag" style="background:rgba(96,165,250,0.2); color:#60a5fa;" >${n.type || 'Info'}

                        </span> <div class="title" style="padding-right: 20px;" >${n.title}

                        </div> <div class="desc" >${n.message}

                        </div> <div class="date" >${new Date(n.date).toLocaleTimeString() + ' ' + new Date(n.date).toLocaleDateString()}

                        </div> <div class="notif-delete" onclick="window.deleteNotification('${n.id}')" style="position:absolute; top:12px; right:12px; cursor:pointer; opacity:0.6; transition:0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'" > <i class="ri-close-line" ></i> </div> </div> `).join('');
                }

                else {
                    inboxContainer.parentElement.style.display = 'none';
                    inboxContainer.innerHTML = '';
                }
            }

            try {
                const res = await fetch('/profiles/api/announcements');
                const data = await res.json();
                const announcements = data.announcements || [];

                if (announcements.length === 0) {
                    if (annContainer) annContainer.parentElement.style.display = 'none';
                }

                else {
                    if (annContainer) {
                        annContainer.parentElement.style.display = 'block';

                        annContainer.innerHTML = announcements.reverse().map(ann => `<divclass="notif-item"><spanclass="changelog-tagannouncement-tag">System</span><divclass="title">NewAnnouncement</div><divclass="desc">${ann.message}</div><divclass="date">${newDate(ann.timestamp).toLocaleString()}</div></div>`).join('');
                    }
                }
            }

            catch (e) {
                if (annContainer) annContainer.parentElement.style.display = 'none';
            }
        }

        let USER_NOTIFICATIONS = [];

        window.deleteNotification = (id) => {
            USER_NOTIFICATIONS = USER_NOTIFICATIONS.filter(n => n.id !== id);

            if (document.getElementById('notification-panel').classList.contains('active')) {
                renderNotifications();
            }

            updateBadge();

            if (window.AuthManager && window.AuthManager.socket) {
                window.AuthManager.socket.emit('deleteNotification', {
                    id
                });
            }
        }

        window.addEventListener('light:notification', (e) => {
            USER_NOTIFICATIONS.unshift(e.detail);
            updateBadge();

            if (document.getElementById('notification-panel').classList.contains('active')) {
                renderNotifications();
            }
        });

        if (window.AuthManager && window.AuthManager.socket) {
            window.AuthManager.socket.on('notificationsList', ({
                notifications

            }) => {
                USER_NOTIFICATIONS = notifications;
                updateBadge();
            });
            window.AuthManager.socket.emit('getNotifications');
        }

        else {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    if (window.AuthManager && window.AuthManager.socket) {
                        window.AuthManager.socket.on('notificationsList', ({
                            notifications

                        }) => {
                            USER_NOTIFICATIONS = notifications;
                            updateBadge();
                        });
                        window.AuthManager.socket.emit('getNotifications');
                    }
                }, 1000);
            });
        }

        async function updateBadge() {
            const badge = document.getElementById('notification-badge');
            const btn = document.getElementById('notification-btn');
            if (!badge) return;

            const lastRead = parseInt(localStorage.getItem('light-last-read-notif') || '0');
            let unreadCount = 0;

            if (lastRead === 0) unreadCount = 1;

            try {
                const unreadUser = USER_NOTIFICATIONS.filter(n => n.date > lastRead).length;
                unreadCount += unreadUser;

                const res = await fetch('/profiles/api/announcements');
                const data = await res.json();
                const announcements = data.announcements || [];
                unreadCount += announcements.filter(a => a.timestamp > lastRead).length;
            }

            catch (e) { }

            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.add('active');
            }

            else {
                badge.classList.remove('active');
            }

            if (btn) btn.style.display = 'flex';
        }

        document.addEventListener('DOMContentLoaded', updateBadge);
        setInterval(updateBadge, 60000);


        function acceptTOS() {
            localStorage.setItem('light-tos-accepted', 'true');
            const overlay = document.getElementById('tos-overlay');
            if (window.resolveTOS) window.resolveTOS();
            overlay.classList.remove('active');

            setTimeout(() => {
                overlay.style.display = 'none';
            }

                , 500);
        }

        function declineTOS() {
            window.location.href = 'https://google.com';
        }

        window.startTOSFlow = function () {
            return new Promise((resolve) => {
                if (localStorage.getItem('light-tos-accepted') === 'true') {
                    resolve();
                }

                else {
                    window.resolveTOS = resolve;
                    const overlay = document.getElementById('tos-overlay');
                    overlay.style.display = 'flex';
                    // Force reflow
                    overlay.offsetHeight;
                    overlay.classList.add('active');
                }
            });
        }

            ;


        (function initOffscreenCloak() {
            const cloak = document.getElementById('offscreen-cloak');
            const iframe = document.getElementById('cloak-iframe');

            if (!cloak || !iframe) return;

            document.addEventListener('mouseleave', (e) => {
                if (localStorage.getItem('light-cloak-enabled') !== 'true') return;
                if (cloak.style.display === 'flex') return;

                if (e.clientY <= 0 || e.clientX <= 0 || e.clientX >= window.innerWidth || e.clientY >= window.innerHeight) {
                    const targetUrl = localStorage.getItem('light-cloak-url') || 'https://google.com';

                    // Correctly call the global function
                    iframe.src = window.getProxyUrl(targetUrl);

                    cloak.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    cloak.focus();
                }
            });

            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && cloak.style.display === 'flex') {
                    cloak.style.display = 'none';
                    iframe.src = 'about:blank';
                    document.body.style.overflow = '';
                }
            }

                , true);

            cloak.addEventListener('click', () => {
                if (cloak.style.display === 'flex') {
                    cloak.style.display = 'none';
                    iframe.src = 'about:blank';
                    document.body.style.overflow = '';
                }
            });
        })();

    </script>
    <script>function search(input) {

            const engine = localStorage.getItem('light-search-engine') || 'duckduckgo';

            const template = {
                'brave': 'https://search.brave.com/search?q=%s&safesearch=strict',
                'google': 'https://www.google.com/search?q=%s&safe=active',
                'bing': 'https://www.bing.com/search?q=%s&adlt=strict',
                'duckduckgo': 'https://duckduckgo.com/?q=%s&kp=1'
            }

            [engine] || 'https://duckduckgo.com/?q=%s&kp=1';

            // If input is already a valid URL, return it directly
            try {
                const url = new URL(input);
                if (url.protocol === 'http:' || url.protocol === 'https:') return url.toString();
            }

            catch (err) { }

            // Try with http:// prefix for inputs like "example.com"
            try {
                const url = new URL(`http://${input}`);
                if (url.hostname.includes('.')) return url.toString();
            }

            catch (err) { }

            return template.replace("%s", encodeURIComponent(input));
        }

        function openSettingsModal() {
            const container = document.getElementById('settings-content');
            const modal = document.getElementById('settings-modal');
            const bg = document.getElementById('settings-glass-bg');

            modal.classList.add('active');
            if (bg) bg.classList.add('active');

            if (window.renderOSSettings) {
                window.renderOSSettings(container);
            }
        }

        window.closeSettingsModal = function () {
            document.getElementById('settings-modal').classList.remove('active');
            const bg = document.getElementById('settings-glass-bg');
            if (bg) bg.classList.remove('active');
        }

        function createIframeWithOverlay(src, onLoad, tabId = null) {
            const SENSITIVE_URLS = ['/profiles/', '/profiles/index.html'];
            const isSecure = window.top.location.href === 'about:blank';
            const isSensitive = SENSITIVE_URLS.some(url => src.toLocaleLowerCase().includes(url.toLocaleLowerCase()));

            const wrapper = document.createElement('div');
            wrapper.className = 'iframe-wrapper';

            if (isSensitive && !isSecure) {
                // Prevent fetching the sensitive URL by replacing it with about:blank
                // and showing a local gate UI inside the wrapper.
                wrapper.innerHTML = `
                    <div style="width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#000; color:#fff; text-align:center; padding:20px; font-family: 'Inter', sans-serif;">
                        <i data-lucide="lock" style="width:64px; height:64px; color:#f87171; margin-bottom:20px;"></i>
                        <h2 style="font-weight:600; font-size:24px; margin-bottom:12px;">secure tab required</h2>
                        <p style="color:#94a3b8; max-width:400px; line-height:1.6; margin-bottom:24px;">this application contains information that can only be accessed from a secure cloaked tab.</p>
                        <button onclick="window.openSecureTab()" style="padding:12px 24px; background:#3b82f6; border:none; border-radius:8px; color:white; font-weight:600; cursor:pointer; transition: opacity 0.2s;">open secure tab</button>
                    </div>
                `;
                setTimeout(() => { if (window.lucide) lucide.createIcons({ root: wrapper }); }, 10);

                // Return a wrapper with a dummy iframe that won't fetch anything sensitive
                const dummyIframe = document.createElement('iframe');
                dummyIframe.src = 'about:blank';
                dummyIframe.style.display = 'none';
                return { wrapper, iframe: dummyIframe };
            }

            const iframe = document.createElement('iframe');
            iframe.src = src;
            iframe.allow = 'fullscreen; autoplay; clipboard-write; encrypted-media; picture-in-picture';
            iframe.name = 'proxy-frame-' + Date.now();
            iframe.dataset.tabId = tabId || '';
            iframe.dataset.lastSrc = src;

            let isFirstLoad = true;

            iframe.addEventListener('load', () => {
                if (window.tManager && tabId) {
                    window.tManager.stopLoading(tabId);
                }

                // Inject beforeunload listener for in-proxy navigation
                try {
                    if (iframe.contentWindow) {
                        iframe.contentWindow.addEventListener('beforeunload', () => {
                            if (window.tManager && tabId) window.tManager.startLoading(tabId);
                        });

                        // Also try to catch click events on links to force loading bar early
                        iframe.contentWindow.document.addEventListener('click', (e) => {
                            const anchor = e.target.closest('a');

                            if (anchor && anchor.href && !anchor.href.startsWith('javascript:') && !anchor.href.startsWith('#')) {
                                if (window.tManager && tabId) window.tManager.startLoading(tabId);
                            }
                        });
                    }
                }

                catch (e) { }

                if (onLoad) {
                    try {
                        onLoad();
                    }

                    catch (e) { }
                }

                if (!isFirstLoad && iframe.dataset.tabId && window.tManager) {
                    try {
                        const currentSrc = iframe.contentWindow.location.pathname + iframe.contentWindow.location.search;
                        const lastSrc = iframe.dataset.lastSrc || '';

                        if (currentSrc && currentSrc !== lastSrc && (currentSrc.startsWith('/sj/') || currentSrc.startsWith('/astronomy/') || currentSrc.startsWith('/service/') || currentSrc.startsWith('/tinyjet/') || currentSrc.startsWith('/bare/') || currentSrc.startsWith('/literature/route/'))) {
                            const title = iframe.contentDocument?.title || 'Page';

                            if (Date.now() - (window.tManager.lastHistoryNavTime || 0) > 1000) {
                                window.tManager.pushToHistory(iframe.dataset.tabId, currentSrc, title);
                            }

                            iframe.dataset.lastSrc = currentSrc;
                        }
                    }

                    catch (e) { }
                }

                isFirstLoad = false;
            });

            const overlay = document.createElement('div');
            overlay.className = 'iframe-overlay';

            overlay.addEventListener('click', () => {
                overlay.classList.add('hidden');
                iframe.focus();
            });

            wrapper.appendChild(iframe);
            wrapper.appendChild(overlay);

            return {
                wrapper,
                iframe,
                overlay
            }

                ;
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.iframe-wrapper')) {
                document.querySelectorAll('.iframe-overlay.hidden').forEach(o => o.classList.remove('hidden'));
            }
        });


        function navPillAction(action) {
            if (!tManager.activeTabId) return;
            const tabId = tManager.activeTabId;
            const contentEl = document.getElementById(tabId);
            if (!contentEl) return;
            const iframe = contentEl.querySelector('iframe');

            const btn = document.getElementById('nav-' + action);

            if (btn && btn.classList.contains('disabled')) { }

            if (btn) {
                btn.style.opacity = '0.5';

                setTimeout(() => {
                    btn.style.opacity = '';
                }

                    , 150);
            }

            if (action === 'back') {
                if (!tManager.goBack(tabId)) {
                    if (iframe && iframe.contentWindow) {
                        try {
                            iframe.contentWindow.history.back();
                        }

                        catch (e) { }
                    }
                }
            }

            else if (action === 'forward') {
                if (!tManager.goForward(tabId)) {
                    if (iframe && iframe.contentWindow) {
                        try {
                            iframe.contentWindow.history.forward();
                        }

                        catch (e) { }
                    }
                }
            }

            else if (action === 'reload') {
                const reloadBtn = document.getElementById('nav-reload');

                if (reloadBtn) {
                    const icon = reloadBtn.querySelector('.lucide') || reloadBtn.querySelector('svg');

                    if (icon) {
                        icon.classList.remove('spin-animation');
                        void icon.offsetWidth;
                        icon.classList.add('spin-animation');

                        setTimeout(() => {
                            icon.classList.remove('spin-animation');
                        }

                            , 500);
                    }
                }

                if (!iframe) return;

                try {
                    if (iframe.contentWindow) {
                        iframe.contentWindow.location.reload();
                    }

                    else {
                        const src = iframe.src;
                        iframe.src = '';
                        iframe.src = src;
                    }
                }

                catch (e) {
                    const src = iframe.src;
                    iframe.src = '';

                    setTimeout(() => {
                        iframe.src = src;
                    }

                        , 10);
                }
            }
        }

        function initAddressBar() {
            const addressBar = document.getElementById('address-bar');

            if (addressBar && !addressBar.dataset.initialized) {
                addressBar.dataset.initialized = "true";

                addressBar.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && addressBar.value.trim()) {
                        if (window.tManager && tManager.activeTabId) {
                            tManager.navigateTab(tManager.activeTabId, addressBar.value.trim());
                            addressBar.blur();
                        }
                    }
                });

                addressBar.addEventListener('focus', () => {
                    addressBar.select();
                });
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAddressBar);
        }

        else {
            initAddressBar();
        }

        window.navPillAction = navPillAction;


        function togglePrivacyModal(event) {
            if (event) {
                event.stopPropagation();
            }

            const popover = document.getElementById('privacy-popover');

            if (popover) {
                const isActive = popover.classList.contains('active');

                if (isActive) {
                    popover.classList.remove('active');
                }

                else {
                    popover.classList.add('active');
                }
            }
        }

        document.addEventListener('click', (e) => {
            const popover = document.getElementById('privacy-popover');

            if (popover && popover.classList.contains('active')) {
                if (!e.target.closest('#privacy-popover') && !e.target.closest('.lock-icon')) {
                    popover.classList.remove('active');
                }
            }
        });

        window.togglePrivacyModal = togglePrivacyModal;

        window.voidPushSubscribe = async (publicKey) => {
            const runSubscribe = async (isRetry = false) => {
                try {

                    // 1. Force unsubscribe state on retry
                    if (isRetry) {
                        const regs = await navigator.serviceWorker.getRegistrations();

                        for (const r of regs) {
                            if (r.scope.includes('/profiles/') || r.active?.scriptURL.includes('sw-push.js')) {
                                const exSub = await r.pushManager.getSubscription();

                                if (exSub) {
                                    await exSub.unsubscribe().catch(e => e);
                                }

                                await r.unregister().catch(e => e);
                            }
                        }

                        await new Promise(r => setTimeout(r, 1000));
                    }

                    // Round 15: Cache bust and Root Scope (Strengthens identity)
                    const swPath = `/profiles/sw-push.js?v=${Date.now()}

                    `;

                    const registration = await navigator.serviceWorker.register(swPath, {
                        scope: '/'
                    });

                    if (registration.installing || registration.waiting) {
                        const worker = registration.installing || registration.waiting;

                        await new Promise(resolve => {
                            worker.addEventListener('statechange', function () {
                                if (this.state === 'activated') resolve();
                            });
                            setTimeout(resolve, 2000);
                        });
                    }

                    const applicationServerKey = (str) => {
                        const padding = '='.repeat((4 - str.length % 4) % 4);
                        const b64 = (str + padding).replace(/\-/g, '+').replace(/_/g, '/');
                        const rawData = window.atob(b64);
                        const outputArray = new Uint8Array(rawData.length);

                        for (let i = 0; i < rawData.length; ++i) {
                            outputArray[i] = rawData.charCodeAt(i);
                        }

                        return outputArray;
                    }

                        ;

                    const convertedKey = applicationServerKey(publicKey);

                    const sub = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: convertedKey
                    });

                    return sub.toJSON();

                }

                catch (err) {

                    if (!isRetry && (err.name === 'AbortError' || err.message.includes('push service error'))) {
                        return runSubscribe(true);
                    }

                    throw err;
                }
            }

                ;
            return runSubscribe();
        }

            ;

        window.addEventListener('message', async (event) => {
            if (event.data?.type === 'VOID_PUSH_SUBSCRIBE') {
                try {
                    const subscription = await window.voidPushSubscribe(event.data.publicKey);

                    event.source.postMessage({
                        type: 'VOID_PUSH_SUBSCRIPTION', subscription
                    }, event.origin);
                }

                catch (err) {
                    event.source.postMessage({
                        type: 'VOID_PUSH_ERROR', error: err.message
                    }, event.origin);
                }
            }
        });

    </script>
    <script>class TabManager {
            constructor() {
                this.tabs = [];
                this.tabCounter = 0;
                this.activeTabId = null;
                const bar = document.getElementById('tab-bar');
                this.tabBar = bar;
                this.contentArea = document.getElementById('content-area');
                this.newTabBtn = document.getElementById('new-tab-btn');

                this.tabHistories = {}

                    ;
                this.lastHistoryNavTime = 0;
                this.loadingTabs = new Set();
                setInterval(() => this.checkActiveTabLocation(), 500);
                setInterval(() => this.safesearchGuard(), 500);
            }

            startLoading(tabId) {
                if (!tabId) return;
                this.loadingTabs.add(tabId);

                if (this.activeTabId === tabId) {
                    this.updateLoadingBar();
                }
            }

            stopLoading(tabId) {
                if (!tabId) return;
                this.loadingTabs.delete(tabId);

                if (this.activeTabId === tabId) {
                    this.updateLoadingBar();
                }
            }

            updateLoadingBar() {
                const bar = document.getElementById('classic-load-bar');
                if (!bar) return;

                const style = localStorage.getItem('light-tab-style');
                const isClassic = (!style || style === 'default');

                if (isClassic && this.activeTabId && this.loadingTabs.has(this.activeTabId)) {
                    bar.classList.remove('finished');
                    bar.classList.add('loading');
                }

                else {
                    if (bar.classList.contains('loading')) {
                        bar.classList.remove('loading');
                        bar.classList.add('finished');
                    }

                    else {
                        bar.classList.remove('finished');
                    }
                }
            }

            searchPlaceholders = ["search privately...",
                "search securely...",
                "search the web...",
                "search anonymously...",
                "search privately...",
                "search securely...",
                "search the web...",
                "search anonymously...",
                "search better...",
                "search smoother..."];

            xorDecode(input) {
                if (!input) return input;

                try {
                    let str = input;
                    let query = '';

                    // Handle query strings that might be appended after encoding
                    const queryIndex = str.indexOf('?');

                    if (queryIndex !== -1) {
                        query = str.slice(queryIndex);
                        str = str.slice(0, queryIndex);
                    }

                    // Attempt to decode
                    let decoded;

                    try {
                        let inner = str;

                        const match = str.match(/^([a-z0-9]{8}\/[a-z0-9]{8}\/)(.*)$/);

                        if (match) {
                            inner = match[2];
                        }

                        decoded = decodeURIComponent(inner).split('').map((char, ind) => ind % 2 ? String.fromCharCode(char.charCodeAt(0) ^ 2) : char).join('');
                    }

                    catch (e) {
                        return input;
                    }

                    // Post-decoding validation
                    if (!decoded) return input;

                    // Re-attach query if it exists
                    if (query) {
                        if (decoded.startsWith('http')) {
                            try {
                                const url = new URL(decoded);

                                // If the decoded URL already has a search component, we might want to merge or replace
                                // For now, let's assume the query param belongs to the target URL
                                if (url.search) {
                                    // If new query duplicates, we might want to handle it, but appending is safest for now
                                    // Actually, standard behavior is URL replacement usually
                                    url.search = query;
                                }

                                else {
                                    url.search = query;
                                }

                                return url.toString();
                            }

                            catch (e) {
                                // If URL parsing fails, just append
                                return decoded + query;
                            }
                        }

                        else {
                            return decoded + query;
                        }
                    }

                    return decoded;
                }

                catch (e) {
                    return input;
                }
            }

            safesearchGuard() {
                const id = this.activeTabId;
                if (!id) return;
                const tab = this.tabs.find(t => t.id === id);
                if (!tab || !tab.isBrowser) return;

                const contentEl = document.getElementById(id);
                const iframe = contentEl?.querySelector('iframe');
                if (!iframe || !iframe.contentWindow) return;

                try {
                    let src = iframe.src;

                    try {
                        if (iframe.contentWindow && iframe.contentWindow.location.href !== 'about:blank') {
                            src = iframe.contentWindow.location.href;
                        }
                    }

                    catch (e) { }

                    let path = src;

                    try {
                        const u = new URL(src, window.location.origin);
                        path = u.pathname + u.search;
                    }

                    catch (e) { }

                    // Support all known prefixes and fallback
                    let encoded = null;
                    if (path.startsWith('/sj/')) encoded = path.replace('/sj/', '');
                    else if (path.startsWith('/astronomy/')) encoded = path.replace('/astronomy/', '');
                    else if (path.startsWith('/service/')) encoded = path.replace('/service/', '');
                    else if (path.startsWith('/tinyjet/')) encoded = path.replace('/tinyjet/', '');
                    else if (path.startsWith('/bare/')) encoded = path.replace('/bare/', '');
                    else if (path.startsWith('/literature/route/')) encoded = path.replace('/literature/route/', '');

                    if (!encoded) return;

                    const encodedPart = encoded;

                    const decoded = this.xorDecode(encodedPart);
                    if (!decoded.startsWith('http')) return;

                    const url = new URL(decoded);
                    let changed = false;

                    if (url.hostname.includes('google.com') && url.pathname.startsWith('/search')) {
                        if (url.searchParams.get('safe') !== 'active') {
                            url.searchParams.set('safe', 'active');
                            url.searchParams.set('ssui', 'on');
                            changed = true;
                        }
                    }

                    else if (url.hostname.includes('bing.com') && url.pathname.startsWith('/search')) {
                        if (url.searchParams.get('adlt') !== 'strict') {
                            url.searchParams.set('adlt', 'strict');
                            changed = true;
                        }
                    }

                    else if (url.hostname.includes('search.brave.com') && url.pathname.startsWith('/search')) {
                        if (url.searchParams.get('safesearch') !== 'strict') {
                            url.searchParams.set('safesearch', 'strict');
                            changed = true;
                        }
                    }

                    else if (url.hostname.includes('duckduckgo.com')) {
                        if (url.searchParams.get('kp') !== '1') {
                            url.searchParams.set('kp', '1');
                            changed = true;
                        }
                    }

                    if (changed) {
                        const xorEncode = (str) => encodeURIComponent(str.split('').map((char, ind) => ind % 2 ? String.fromCharCode(char.charCodeAt(0) ^ 2) : char).join(''));
                        iframe.src = prefix + xorEncode(url.toString());
                    }
                }

                catch (e) { }
            }

            initTabHistory(tabId) {
                this.tabHistories[tabId] = {
                    history: [],
                    index: -1
                }

                    ;
            }

            checkActiveTabLocation() {
                const id = this.activeTabId;
                if (!id) return;

                const tab = this.tabs.find(t => t.id === id);
                if (!tab || !tab.isBrowser) return;

                const contentEl = document.getElementById(id);
                if (!contentEl) return;
                const iframe = contentEl.querySelector('iframe');
                if (!iframe || !iframe.contentWindow) return;

                try {

                    // Check if loading
                    try {
                        if (iframe.contentDocument && iframe.contentDocument.readyState !== 'complete') {
                            this.startLoading(id);
                        }
                    }

                    catch (e) { }

                    // Reduced throttle to 500ms to catch more navigation events
                    if (this.lastHistoryNavTime && Date.now() - this.lastHistoryNavTime < 500) return;

                    let currentPath = iframe.contentWindow.location.pathname + iframe.contentWindow.location.search;

                    console.log('checkActiveTabLocation debug:', {
                        currentPath, activeTabId: id
                    });


                    // Support all known prefixes and fallback
                    let encoded = null;
                    if (currentPath.startsWith('/sj/')) encoded = currentPath.replace('/sj/', '');
                    else if (currentPath.startsWith('/astronomy/')) encoded = currentPath.replace('/astronomy/', '');
                    else if (currentPath.startsWith('/service/')) encoded = currentPath.replace('/service/', '');
                    else if (currentPath.startsWith('/tinyjet/')) encoded = currentPath.replace('/tinyjet/', '');
                    else if (currentPath.startsWith('/bare/')) encoded = currentPath.replace('/bare/', '');
                    else if (currentPath.startsWith('/literature/route/')) encoded = currentPath.replace('/literature/route/', '');
                    else if (currentPath !== '/v2/' && currentPath !== '/') encoded = currentPath; // Fallback for other paths

                    if (!encoded) return;

                    let decoded = encoded;

                    try {
                        decoded = this.xorDecode(encoded);
                    }

                    catch (e) { }

                    if (!decoded) decoded = currentPath;

                    // Sync address bar if it's the active tab
                    if (id === this.activeTabId) {
                        const addressBar = document.getElementById('address-bar');

                        if (addressBar && document.activeElement !== addressBar) {
                            if (addressBar.value !== decoded) {
                                addressBar.value = decoded;
                            }
                        }

                    }

                    const hist = this.tabHistories[id];

                    if (hist && hist.history.length > 0) {
                        const last = hist.history[hist.index];

                        if (last.type === 'browser') {
                            // Normalize last URL to check for changes
                            let lastEncoded = null;
                            const lastUrl = last.proxyUrl || '';
                            if (lastUrl.startsWith('/sj/')) lastEncoded = lastUrl.replace('/sj/', '');
                            else if (lastUrl.startsWith('/service/')) lastEncoded = lastUrl.replace('/service/', '');
                            else if (lastUrl.startsWith('/tinyjet/')) lastEncoded = lastUrl.replace('/tinyjet/', '');
                            else if (lastUrl.startsWith('/bare/')) lastEncoded = lastUrl.replace('/bare/', '');
                            else if (lastUrl.startsWith('/literature/route/')) lastEncoded = lastUrl.replace('/literature/route/', '');
                            else lastEncoded = lastUrl;

                            if (encoded !== lastEncoded && currentPath !== lastUrl) {
                                // Ensure strict uniqueness for history to fix back button loops
                                this.pushToHistory(id, currentPath, iframe.contentDocument.title || 'Page');
                                iframe.dataset.lastSrc = currentPath;
                            }
                        }
                    }

                    else if (hist && hist.history.length === 0) {
                        // Initialize history if empty
                        this.pushToHistory(id, currentPath, iframe.contentDocument.title || 'Page');
                        iframe.dataset.lastSrc = currentPath;
                    }
                }

                catch (e) { }
            }

            pushToHistory(tabId, url, originalUrl) {
                if (!this.tabHistories[tabId]) {
                    this.initTabHistory(tabId);
                }

                const hist = this.tabHistories[tabId];

                if (hist.index < hist.history.length - 1) {
                    hist.history = hist.history.slice(0, hist.index + 1);
                }

                hist.history.push({
                    type: 'browser', proxyUrl: url, originalUrl: originalUrl
                });
                hist.index = hist.history.length - 1;

                this.updateNavButtons(tabId);
            }

            canGoBack(tabId) {
                const hist = this.tabHistories[tabId];
                return hist && hist.history.length > 1 && hist.index > 0;
            }

            canGoForward(tabId) {
                const hist = this.tabHistories[tabId];
                return hist && hist.index < hist.history.length - 1;
            }

            goBack(tabId) {
                const hist = this.tabHistories[tabId];

                if (!hist || hist.index <= 0) {

                    return false;
                }

                this.lastHistoryNavTime = Date.now();
                hist.index--;
                const entry = hist.history[hist.index];
                this.loadHistoryEntry(tabId, entry);
                this.updateNavButtons(tabId);
                return true;
            }

            goForward(tabId) {
                const hist = this.tabHistories[tabId];

                if (!hist || hist.index >= hist.history.length - 1) {

                    return false;
                }

                this.lastHistoryNavTime = Date.now();
                hist.index++;
                const entry = hist.history[hist.index];
                this.loadHistoryEntry(tabId, entry);
                this.updateNavButtons(tabId);
                return true;
            }

            loadHistoryEntry(tabId, entry) {
                const contentEl = document.getElementById(tabId);
                if (!contentEl) return;

                this.startLoading(tabId);

                if (entry.type === 'newtab') {
                    this.stopLoading(tabId);
                    contentEl.innerHTML = this.getNewTabHTML(tabId);
                    contentEl.classList.add('app-internal');

                    lucide.createIcons({
                        root: contentEl
                    });
                    this.initNewTab(tabId);

                    const tabData = this.tabs.find(t => t.id === tabId);

                    if (tabData) {
                        tabData.type = 'newtab';
                        tabData.isBrowser = false;
                    }

                    this.updateTabInfo(tabId, 'home', null);

                    const navPill = document.getElementById('nav-pill');
                    if (navPill) navPill.classList.remove('active');

                    const addressBar = document.getElementById('address-bar');
                    if (addressBar) addressBar.value = '';


                    return;
                }

                const iframe = contentEl.querySelector('iframe');

                if (iframe) {
                    iframe.src = entry.proxyUrl;
                }

                else {
                    contentEl.innerHTML = '';

                    const {
                        wrapper
                    }

                        = createIframeWithOverlay(entry.proxyUrl, null, tabId);
                    contentEl.appendChild(wrapper);
                    contentEl.classList.remove('app-internal');

                    const tabData = this.tabs.find(t => t.id === tabId);

                    if (tabData) {
                        tabData.type = 'browser';
                        tabData.isBrowser = true;
                    }

                    const navPill = document.getElementById('nav-pill');
                    if (navPill) navPill.classList.add('active');
                }


                const addressBar = document.getElementById('address-bar');

                if (addressBar) {
                    if (entry.type === 'newtab') {
                        addressBar.value = '';
                    }

                    else {
                        if (entry.originalUrl || entry.proxyUrl) {
                            addressBar.value = entry.originalUrl || entry.proxyUrl;
                        }
                    }

                }
            }

            updateNavButtons(tabId) {
                if (tabId !== this.activeTabId) return;
                const canBack = this.canGoBack(tabId);
                const canForward = this.canGoForward(tabId);

                const backBtn = document.getElementById('nav-back');
                const forwardBtn = document.getElementById('nav-forward');

                if (backBtn) {
                    backBtn.classList.toggle('disabled', !canBack);
                }

                if (forwardBtn) {
                    forwardBtn.classList.toggle('disabled', !canForward);
                }


            }

            addTab(type = 'newtab', url = null, title = 'home') {
                const id = `tab-${this.tabCounter++}`;

                const tabData = {
                    id,
                    type,
                    url,
                    title
                }

                    ;
                const tabEl = document.createElement('div');
                tabEl.className = 'tab-item';
                tabEl.dataset.id = id;

                let previewImg = 'https://www.google.com/s2/favicons?sz=128&domain=google.com';

                if (type === 'newtab') {
                    previewImg = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    if (window.updateTabInfo) this.updateTabInfo(id, 'home', null);
                }

                else if (type === 'activities') {
                    previewImg = 'LUCIDE_JOYSTICK';
                }

                else if (type === 'browser' && url) {
                    try {
                        const urlObj = new URL(url);
                        previewImg = `https://www.google.com/s2/favicons?sz=128&domain=${urlObj.hostname}`;
                    }

                    catch (e) { }
                }

                else if (type === 'app-iframe') {
                    try {
                        const urlObj = new URL(url, window.location.origin);

                        if (urlObj.hostname !== window.location.hostname) {
                            previewImg = `https://www.google.com/s2/favicons?sz=128&domain=${urlObj.hostname}`;
                        }

                        else {
                            const lowTitle = title.toLowerCase();
                            if (lowTitle === 'files') previewImg = 'https://cdn-icons-png.flaticon.com/512/3767/3767084.png';
                            else if (lowTitle.includes('settings')) previewImg = 'https://cdn-icons-png.flaticon.com/512/3524/3524636.png';
                            else if (lowTitle.includes('profiles') || lowTitle === 'messages') previewImg = 'LUCIDE_MESSAGE_SQUARE'; // Marker for custom handling
                        }
                    }

                    catch (e) { }
                }

                let previewContent = `<img src="${previewImg}" onerror="this.src='https://www.google.com/s2/favicons?sz=64&domain=google.com'">`;

                if (previewImg === 'LUCIDE_MESSAGE_SQUARE') {
                    previewContent = `<i data-lucide="message-square" style="width:16px;height:16px;color:rgba(255,255,255,0.8);"></i>`;
                } else if (previewImg === 'LUCIDE_JOYSTICK') {
                    previewContent = `<i data-lucide="joystick" style="width:16px;height:16px;color:rgba(255,255,255,0.8);"></i>`;
                }

                tabEl.innerHTML = ` <div class="tab-preview">${previewContent}</div><div class="tab-title">${title}</div><div class="tab-close"><i data-lucide="x" style="width:14px;height:14px;"></i></div>`;

                lucide.createIcons({
                    root: tabEl
                });

                tabEl.onclick = (e) => {
                    if (!e.target.closest('.tab-close')) this.switchToTab(id);
                }

                    ;

                tabEl.querySelector('.tab-close').onclick = (e) => {
                    e.stopPropagation();
                    this.closeTab(id);
                };

                // FORCE RELATIVE POSITIONING
                tabEl.style.position = 'relative';
                tabEl.style.transform = 'none';
                tabEl.style.bottom = 'auto';
                tabEl.style.top = 'auto';
                tabEl.style.left = 'auto';
                tabEl.style.right = 'auto';
                tabEl.style.margin = '0 0 8px 0';
                tabEl.style.color = 'inherit'; // Let theme decide, but don't hide it

                if (window.makeMagnetic) makeMagnetic(tabEl);

                if (!this.tabBar) {
                    this.tabBar = document.getElementById('tabs-list');
                }

                if (!this.contentArea) this.contentArea = document.getElementById('content-area');

                // Find the correct container for tabs
                let tabsList = document.getElementById('tabs-list');
                if (!tabsList) {
                    tabsList = this.tabBar;
                }

                if (tabsList) {
                    tabsList.appendChild(tabEl);

                    // Reposition New Tab button to be ALWAYS at the end
                    const newTabBtn = document.getElementById('new-tab-btn');
                    if (newTabBtn && tabsList.contains(newTabBtn)) {
                        tabsList.appendChild(newTabBtn);
                    }
                }

                const contentEl = document.createElement('div');
                contentEl.id = id;
                contentEl.className = 'tab-content';

                if (type === 'newtab') {
                    contentEl.classList.add('app-internal');
                    contentEl.innerHTML = this.getNewTabHTML(id);

                    lucide.createIcons({
                        root: contentEl
                    });
                    // Initialized after appending to DOM below
                }

                else if (type === 'browser') {
                    tabData.isBrowser = true;

                    // Initial setup (empty iframe)
                    const {
                        wrapper,
                        iframe
                    }

                        = createIframeWithOverlay('about:blank', () => {
                            try {
                                const t = iframe.contentDocument.title;

                                if (t) {
                                    this.updateTabInfo(id, t, iframe.src);
                                }

                                setTimeout(() => this.captureTab(id), 500);
                            }

                            catch (e) { }
                        }

                            , id);
                    contentEl.appendChild(wrapper);

                    // Initialize history
                    this.initTabHistory(id);

                    // Use navigateTab flow to handle actual navigation (proxied)
                    if (url) {
                        this.navigateTab(id, url, title);
                    }

                    else {
                        this.pushToHistory(id, 'about:blank', 'Empty Page');
                    }
                }

                else if (type === 'terminal') {
                    const {
                        wrapper
                    }

                        = createIframeWithOverlay('jor1k/demos/main.html', () => {
                            setTimeout(() => this.captureTab(id), 1000);
                        });
                    contentEl.appendChild(wrapper);
                }

                else if (type === 'app-iframe') {
                    const {
                        wrapper,
                        iframe
                    }

                        = createIframeWithOverlay(url, () => {
                            try {
                                const t = iframe.contentDocument.title;

                                if (t && t !== title) {
                                    this.updateTabInfo(id, t, iframe.src);
                                }

                                setTimeout(() => this.captureTab(id), 500);
                            }

                            catch (e) { }
                        });
                    contentEl.appendChild(wrapper);
                }

                else if (type === 'activities') {

                    // Activities App
                    // We need to initialize the activities manager in this container
                    if (window.ActivitiesManager) {
                        const activitiesManager = new window.ActivitiesManager();

                        // We'll init it after appending to DOM to ensure elements exist
                        setTimeout(() => {
                            activitiesManager.init(id);
                        }

                            , 0);
                    }
                }

                if (this.contentArea) {
                    this.contentArea.appendChild(contentEl);
                    if (type === 'newtab') this.initNewTab(id);
                }

                this.tabs.push(tabData);

                if (type === 'newtab') {
                    this.initTabHistory(id);

                    this.tabHistories[id].history.push({
                        type: 'newtab'
                    });
                    this.tabHistories[id].index = 0;
                }

                this.switchToTab(id);
                if (window.updateRadialLayout) window.updateRadialLayout();
            }

            updateTabInfo(id, title, url) {
                const tabEl = document.querySelector(`.tab-item[data-id="${id}"]`);

                if (tabEl) {
                    const titleEl = tabEl.querySelector('.tab-title');
                    const previewText = tabEl.querySelector('.preview-text');

                    if (title) {
                        if (titleEl) titleEl.textContent = title;
                        if (previewText) previewText.textContent = title;
                    }
                }
            }

            captureTab(id) {
                const contentEl = document.getElementById(id);
                if (!contentEl || contentEl.classList.contains('app-internal')) return;

                const tabItem = document.querySelector(`.tab-item[data-id="${id}"]`);
                if (!tabItem) return;

                let target = contentEl;
                const iframe = contentEl.querySelector('iframe');

                if (iframe) {
                    try {
                        if (iframe.contentDocument && iframe.contentDocument.body) {
                            target = iframe.contentDocument.body;
                        }
                    }

                    catch (e) {
                        return;
                    }
                }

                if (window.html2canvas) {
                    requestIdleCallback(() => {
                        html2canvas(target, {
                            scale: 0.2,
                            useCORS: true,
                            logging: false,
                            height: Math.min(target.scrollHeight, 1080),
                            windowHeight: 1080

                        }).then(canvas => {
                            const imgData = canvas.toDataURL('image/jpeg', 0.5);
                            const img = tabItem.querySelector('.tab-preview img');
                            if (img) img.src = imgData;

                        }).catch(e => { });
                    }

                        , {
                            timeout: 1000
                        });
                }
            }

            switchToTab(id) {
                if (this.activeTabId && this.activeTabId !== id) {
                    this.captureTab(this.activeTabId);
                }

                this.activeTabId = id;
                this.updateLoadingBar();
                document.querySelectorAll('.tab-item').forEach(t => t.classList.toggle('active', t.dataset.id === id));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === id));

                const tabData = this.tabs.find(t => t.id === id);

                this.updateNavButtons(id);


                const navBar = document.getElementById('nav-bar');

                if (navBar) {
                    navBar.classList.toggle('active', ! !(tabData && tabData.isBrowser));


                    const addressBar = document.getElementById('address-bar');

                    if (addressBar) {
                        if (tabData && tabData.isBrowser) {
                            const hist = this.tabHistories[id];
                            const entry = hist ? hist.history[hist.index] : null;
                            addressBar.value = entry ? (entry.originalUrl || entry.proxyUrl) : '';
                        }

                        else {
                            addressBar.value = '';
                        }
                    }


                }
            }

            closeTab(id) {
                const idx = this.tabs.findIndex(t => t.id === id);
                if (idx === -1) return;
                document.querySelector(`.tab-item[data-id="${id}"]`).remove();
                document.getElementById(id).remove();
                this.tabs.splice(idx, 1);
                if (window.updateRadialLayout) window.updateRadialLayout();

                if (this.activeTabId === id) {
                    if (this.tabs.length > 0) {
                        const newIdx = Math.min(idx, this.tabs.length - 1);
                        this.switchToTab(this.tabs[newIdx].id);
                    }

                    else {
                        this.addTab('newtab');
                    }
                }
            }

            async navigateTab(id, input, titleOverride = null) {
                this.startLoading(id);
                const url = search(input);
                if (window.addToSearchHistory) window.addToSearchHistory(input);

                try {
                    if (window.controllerReadyPromise) {
                        await Promise.race([window.controllerReadyPromise,
                        new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 3000))]);
                    }
                }

                catch (e) { }

                try {
                    if (window.BareMux) {
                        const connection = new BareMux.BareMuxConnection("/baremux/worker.js");
                        const transport = "/epoxy/index.mjs";
                        const wispUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/wisp/";

                        if ((await connection.getTransport()) !== transport) {
                            await connection.setTransport(transport, [{
                                wisp: wispUrl
                            }

                            ]);
                        }
                    }
                }

                catch (e) { }

                const contentEl = document.getElementById(id);
                contentEl.classList.remove('app-internal');
                contentEl.innerHTML = '';

                const wrapper = document.createElement('div');
                wrapper.className = 'iframe-wrapper';
                wrapper.style.cssText = 'position:relative;width:100%;height:100%;flex:1;display:flex;';

                const iframe = document.createElement('iframe');
                iframe.className = 'tab-iframe';
                iframe.allow = 'fullscreen; autoplay; clipboard-write; encrypted-media; picture-in-picture';
                iframe.style.cssText = 'width:100%;height:100%;border:none;flex:1;';
                wrapper.appendChild(iframe);
                contentEl.appendChild(wrapper);

                if (window.scramjet && window.scramjet.controller) {
                    try {
                        const frame = window.scramjet.controller.createFrame(iframe);
                        frame.go(url);
                    }

                    catch (e) {
                        iframe.src = url;
                    }
                }

                else {
                    iframe.src = url;
                }

                iframe.onload = () => {
                    this.stopLoading(id);

                    try {
                        const t = iframe.contentDocument?.title;

                        if (t) {
                            this.updateTabInfo(id, t, null);
                        }

                        setTimeout(() => this.captureTab(id), 500);
                    }

                    catch (e) { }
                }

                    ;

                this.pushToHistory(id, url, url);

                const tabData = this.tabs.find(t => t.id === id);

                if (tabData) {
                    tabData.isBrowser = true;
                    tabData.type = 'browser';
                }

                this.updateTabInfo(id, titleOverride || input, null);

                const navPill = document.getElementById('nav-pill');
                if (navPill) navPill.classList.add('active');


                const navBar = document.getElementById('nav-bar');
                if (navBar) navBar.classList.add('active');
                const addressBar = document.getElementById('address-bar');
                if (addressBar) addressBar.value = url;

                this.updateNavButtons(id);

                try {
                    const targetUrlObj = new URL(url);
                    const iconUrl = `https://www.google.com/s2/favicons?sz=128&domain=${targetUrlObj.hostname}`;
                    const tabEl = document.querySelector(`.tab-item[data-id="${id}"]`);

                    if (tabEl) {
                        const img = tabEl.querySelector('.tab-preview img');
                        if (img) img.src = iconUrl;
                    }
                }

                catch (e) { }
            }

            getNewTabHTML(id) {
                const placeholder = this.searchPlaceholders[Math.floor(Math.random() * this.searchPlaceholders.length)];
                return `
                <div class="nt-container" id="nt-container-${id}">
                    <div class="nt-header-group">
                        <div class="nt-clock" id="nt-clock-${id}">loading weather...</div>
                        <div class="nt-sub-group">
                            <div class="nt-greeting" id="nt-greet-${id}" style="margin:0;">...</div>
                        </div>
                    </div>
                    <form class="glass-search" style="margin-bottom:30px;" onsubmit="event.preventDefault(); tManager.navigateTab('${id}', this.querySelector('input').value)">
                        <div class="glass-filter"></div>
                        <div class="glass-overlay"></div>
                        <div class="glass-specular"></div>
                        <div class="glass-content">
                            <div class="search-container">
                                <i data-lucide="search" class="search-icon" style="pointer-events:none;"></i>
                                <input type="text" placeholder="${placeholder}" class="search-input nt-input" autofocus>
                                <button class="search-clear" type="button" aria-label="Clear search" onclick="if(window.clearGlassSearch)window.clearGlassSearch(this)">
                                    <i data-lucide="x" style="pointer-events:none;"></i>
                                </button>
                            </div>
                            <div class="search-suggestions">
                                <div class="suggestion-group">
                                    <h4 style="display:none;">suggestions</h4>
                                    <ul></ul>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>`;
            }

            initNewTab(id) {
                const el = document.getElementById(`nt-greet-${id}`);
                const h = new Date().getHours();
                let g = 'good night';
                if (h >= 5 && h < 12) g = 'good morning';
                else if (h >= 12 && h < 17) g = 'good afternoon';
                else if (h >= 17 && h < 21) g = 'good evening';

                if (el) el.textContent = g;

                const greetings = [
                    "unsure? undoubtably.",
                    "your data, is yours.",
                    "privacy first, always.",
                    "whats yours, stays yours.",
                    "your privacy, secured.",
                ];

                setTimeout(() => {
                    const target = document.getElementById(`nt-greet-${id}`);
                    if (!target) return;

                    setInterval(() => {
                        const cur = document.getElementById(`nt-greet-${id}`);
                        if (!cur) return;

                        const newGreet = greetings[Math.floor(Math.random() * greetings.length)];
                        const oldWidth = cur.offsetWidth;

                        cur.style.width = oldWidth + 'px';
                        cur.style.opacity = '0';

                        setTimeout(() => {
                            cur.style.transition = 'none';
                            cur.style.width = 'auto';
                            cur.textContent = newGreet;
                            const newWidth = cur.offsetWidth;

                            cur.style.width = oldWidth + 'px';
                            cur.offsetHeight;
                            cur.style.transition = '';

                            cur.style.width = newWidth + 'px';
                            cur.style.opacity = '1';

                            setTimeout(() => { cur.style.width = 'auto'; }, 500);
                        }, 500);
                    }, 5000);
                }, 3000);

                const update = () => {
                    if (window.updateWeather) window.updateWeather();
                }

                update();

                const interval = setInterval(() => {
                    if (!document.getElementById(`nt-clock-${id}`)) {
                        clearInterval(interval);
                        return;
                    }
                    update();
                }, 300000); // 5 mins

                setTimeout(() => {
                    if (window.initGlassSearch) window.initGlassSearch(`nt-container-${id}`);
                }, 100);
            }
        }

        const tManager = new TabManager();
        window.tManager = tManager;


        // Auto-init removed. Controlled by index.html via window.initTab
        window.initTabManager = async () => {
            await window.proxyReady;
            tManager.addTab('newtab');
        }

            ;

    </script>
    <script>class ActivitiesManager {
            static instances = [];

            constructor() {
                ActivitiesManager.instances.push(this);

                this.SOURCE_CONFIG = {
                    gnMath: {
                        zones: "https://cdn.jsdelivr.net/gh/gn-math/assets@main/zones.json",
                        covers: "https://cdn.jsdelivr.net/gh/gn-math/covers@main",
                        html: "https://cdn.jsdelivr.net/gh/gn-math/html@main"
                    }

                    ,
                    selenite: {
                        games: "https://selenite.cc/resources/games.json",
                        assets: "https://selenite.cc/resources/semag"
                    }

                    ,
                    truffled: {
                        games: "https://truffled.lol/js/json/g.json",
                        assets: "https://truffled.lol"
                    }

                    ,
                    velara: {
                        games: "https://velara.cc/json/gg.json",
                        assets: "https://velara.cc"
                    }

                    ,
                    duckMath: {
                        games: "https://cdn.jsdelivr.net/gh/duckmath/duckmath.github.io@main/backup_classes.json"
                    }
                }

                    ;

                this.MAX_VISIBLE_GAMES = 500;
                this.SCROLL_THRESHOLD = 350;
            }

            init(containerId) {
                // ... (init function remains exactly the same) ...
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = `
                <div class="activities-container">
                    <div class="games-topbar">
                        <div class="games-header-left" style="display:flex; align-items:center; gap:12px; margin-right:16px;">
                        </div>
                        <div class="glass-search games-search-bar" style="flex:1;">
                            <div class="glass-filter"></div>
                            <div class="glass-overlay"></div>
                            <div class="glass-content">
                                <i data-lucide="search" class="games-search-icon"></i>
                                <input type="text" class="activity-search-input" placeholder="search activities..." autocomplete="off">
                            </div>
                        </div>
                        <div class="games-refresh-btn nav-btn" title="Refresh Games" style="width:36px; height:36px; display:flex; align-items:center; justify-content:center; margin-left:12px;">
                            <i data-lucide="rotate-cw"></i>
                        </div>
                    </div>
                    <div class="game-grid-container">
                        <div class="game-grid"></div>
                        <div class="game-grid-sentinel"></div>
                        <p class="no-results-message">fetching activities...</p>
                    </div>
                </div>`;

                lucide.createIcons({
                    root: container
                });

                this.container = container;
                this.gameGrid = container.querySelector('.game-grid');
                this.searchInput = container.querySelector('.activity-search-input');
                this.noResultsEl = container.querySelector('.no-results-message');
                this.refreshBtn = container.querySelector('.games-refresh-btn');
                this.sentinel = container.querySelector('.game-grid-sentinel');
                this.gridContainer = container.querySelector('.game-grid-container');

                this.allGames = [];
                this.currentFilteredGames = [];
                this.currentVisibleCount = 0;
                this.gameDataLoaded = false;
                this.loadingMoreGames = false;

                this.setupEventListeners();
                this.loadGames();
            }

            // ... (setupEventListeners, loadGames, reloadGames, setStatus, showSkeletonLoading, createGameCard, filterGames, loadMoreGames remain the same) ...

            setupEventListeners() {
                if (this.searchInput) {
                    this.searchInput.addEventListener('input', () => this.filterGames());
                }

                if (this.refreshBtn) {
                    this.refreshBtn.addEventListener('click', () => {
                        const icon = this.refreshBtn.querySelector('i');
                        if (icon) icon.classList.add('spin-animation');
                        setTimeout(() => { if (icon) icon.classList.remove('spin-animation') }, 500);
                        this.reloadGames();
                    });
                }

                if (this.gameGrid) {
                    this.gameGrid.addEventListener('click', async (e) => {
                        const card = e.target.closest('.game-card');

                        if (card && card.dataset.gameUrl) {
                            let url = card.dataset.gameUrl;
                            const isExternal = card.dataset.isExternal === 'true';
                            const title = card.dataset.gameTitle;



                            try {
                                if (window.controllerReadyPromise) {
                                    await Promise.race([window.controllerReadyPromise,
                                    new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 3000))]);
                                }
                            }

                            catch (e) { }

                            try {
                                if (window.BareMux) {
                                    const connection = new BareMux.BareMuxConnection("/baremux/worker.js");
                                    const transport = "/epoxy/index.mjs";
                                    const wispUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/wisp/";

                                    if ((await connection.getTransport()) !== transport) {
                                        await connection.setTransport(transport, [{
                                            wisp: wispUrl
                                        }

                                        ]);
                                    }
                                }
                            }

                            catch (e) { }



                            if (window.tManager) {
                                window.tManager.addTab('browser', url, title);
                            }

                            else {
                                const proxiedUrl = window.getProxyUrl ? window.getProxyUrl(url) : url;
                                window.open(proxiedUrl, '_blank');
                            }
                        }
                    });
                }

                if (this.sentinel && this.gridContainer) {
                    this.observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                this.loadMoreGames();
                            }
                        });
                    }

                        , {
                            root: this.gridContainer,
                            rootMargin: `0px 0px ${this.SCROLL_THRESHOLD}px 0px`,
                            threshold: 0
                        });
                    this.observer.observe(this.sentinel);
                }
            }

            async loadGames() {
                this.showSkeletonLoading();

                try {
                    if (window.controllerReadyPromise) {
                        await window.controllerReadyPromise.catch(() => { });
                    }

                    const data = await this.fetchGameData();
                    this.allGames = data;
                    this.gameDataLoaded = true;
                    this.filterGames();
                }

                catch (e) {
                    this.setStatus('Go to settings, clear data (backup if needed), and reload the site');
                }
            }

            reloadGames() {
                this.allGames = [];
                this.currentFilteredGames = [];
                this.gameDataLoaded = false;
                if (this.gameGrid) this.gameGrid.innerHTML = '';
                this.loadGames();
            }

            setStatus(msg) {
                if (this.noResultsEl) {
                    this.noResultsEl.textContent = msg;
                    this.noResultsEl.style.display = 'block';
                }

                if (this.gameGrid) {
                    this.gameGrid.style.display = 'none';
                }
            }

            showSkeletonLoading() {
                if (!this.gameGrid) return;
                this.gameGrid.innerHTML = '';
                this.gameGrid.style.display = 'grid';
                if (this.noResultsEl) this.noResultsEl.style.display = 'none';

                for (let i = 0; i < 12; i++) {
                    const card = document.createElement('div');
                    card.className = 'game-card skeleton';
                    card.innerHTML = ` <div class="game-image"></div><div class="game-info"><div class="skeleton-text" style="width: 80%; height: 16px; margin-bottom: 8px;"></div></div>`;
                    this.gameGrid.appendChild(card);
                }
            }

            createGameCard(game) {
                const card = document.createElement('div');
                card.className = 'game-card';
                card.dataset.gameUrl = game.gameUrl;
                card.dataset.isExternal = game.isExternal;
                card.dataset.gameTitle = game.name;

                const img = document.createElement('img');
                img.loading = 'lazy';
                img.onload = () => img.classList.add('loaded');

                // Proxy image through bareClient on demand
                if (game.coverUrl && window.bareClient) {
                    window.bareClient.fetch(game.coverUrl).then(res => {
                        if (!res.ok) throw new Error('not ok');
                        return res.blob();

                    }).then(blob => {
                        img.src = URL.createObjectURL(blob);

                    }).catch(() => {
                        img.src = game.coverUrl; // Fallback to direct URL
                    });
                }

                else {
                    img.src = game.coverUrl || '';
                }

                const info = document.createElement('div');
                info.className = 'game-info';
                const title = document.createElement('h3');
                title.textContent = game.name;
                info.appendChild(title);

                card.appendChild(img);
                card.appendChild(info);

                return card;
            }

            filterGames() {
                if (!this.gameDataLoaded) return;

                const query = (this.searchInput?.value || '').toLowerCase().trim();

                this.currentFilteredGames = this.allGames.filter(game => {
                    return game.name.toLowerCase().includes(query) || (game.author || '').toLowerCase().includes(query);
                });

                if (this.currentFilteredGames.length === 0) {
                    this.setStatus('No games found.');
                    return;
                }

                if (this.noResultsEl) this.noResultsEl.style.display = 'none';
                if (this.gameGrid) this.gameGrid.style.display = 'grid';

                this.currentVisibleCount = 0;
                this.gameGrid.innerHTML = '';
                this.loadMoreGames();

                if (this.searchInput && !query) {
                    this.searchInput.placeholder = `Search through ${this.allGames.length} activities...`;
                }
            }

            loadMoreGames() {
                if (this.loadingMoreGames || this.currentVisibleCount >= this.currentFilteredGames.length) return;

                this.loadingMoreGames = true;
                const nextBatch = this.currentFilteredGames.slice(this.currentVisibleCount, this.currentVisibleCount + this.MAX_VISIBLE_GAMES);

                const fragment = document.createDocumentFragment();

                nextBatch.forEach(game => {
                    fragment.appendChild(this.createGameCard(game));
                });

                if (this.gameGrid) this.gameGrid.appendChild(fragment);
                this.currentVisibleCount += nextBatch.length;

                this.loadingMoreGames = false;
            }

            static updateProvider(newProvider) {
                localStorage.setItem('light-activities-provider', newProvider);

                ActivitiesManager.instances.forEach(instance => {
                    if (instance.gameDataLoaded || instance.gameGrid) {
                        instance.reloadGames();
                    }
                });
            }

            async fetchGameData(source) {
                if (!source) {
                    source = localStorage.getItem('light-activities-provider') || 'truffled';
                }

                // --- PROXY FETCH VIA BARECLIENT ---
                const fetchJson = async (url) => {


                    // Use bareClient.fetch() to proxy CDN requests through BareMux
                    // This bypasses Scramjet URL encoding entirely
                    if (!window.bareClient) {
                        throw new Error("BareClient not available - proxy not initialized");
                    }

                    let retries = 3;

                    while (retries > 0) {
                        try {
                            const res = await window.bareClient.fetch(url, {

                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json'
                                }
                            });
                            if (res.ok) return await res.json();

                            if (res.status !== 500) throw new Error(`${res.status}

                        ${res.statusText}

                        `);
                            throw new Error("500 Internal Server Error");
                        }

                        catch (e) {
                            retries--;
                            if (retries === 0) throw e;
                            await new Promise(r => setTimeout(r, 1500));
                        }
                    }
                }

                    ;

                const resolveUrl = (url, baseUrl) => {
                    if (!url) return '';
                    if (url.startsWith('http')) return url;
                    return baseUrl + (url.startsWith('/') ? '' : '/') + url;
                }

                // proxyImage is now a no-op - images are proxied lazily in createGameCard
                const proxyImage = (url) => url;

                try {
                    if (source === 'selenite') {
                        const data = await fetchJson(this.SOURCE_CONFIG.selenite.games);

                        return data.map(game => ({
                            id: game.directory,
                            name: game.name,
                            author: 'Selenite',
                            // FORCE PROXY on images
                            coverUrl: proxyImage(resolveUrl(`${game.directory}/${game.image}`, this.SOURCE_CONFIG.selenite.assets)),
                            gameUrl: resolveUrl(`${game.directory}/`, this.SOURCE_CONFIG.selenite.assets),
                            isExternal: false,
                            featured: game.tags && game.tags.includes('top')
                        })).sort((a, b) => a.name.localeCompare(b.name));

                    }

                    else if (source === 'truffled') {
                        const data = await fetchJson(this.SOURCE_CONFIG.truffled.games);
                        const games = data.games || [];

                        return games.map(game => {
                            const finalCover = resolveUrl(game.thumbnail, this.SOURCE_CONFIG.truffled.assets);
                            const finalUrl = resolveUrl(game.url, this.SOURCE_CONFIG.truffled.assets);

                            return {
                                id: game.name,
                                name: game.name,
                                author: 'Truffled',
                                // FORCE PROXY on images
                                coverUrl: proxyImage(finalCover),
                                gameUrl: finalUrl,
                                isExternal: false,
                                featured: false
                            }

                                ;
                        }).sort((a, b) => a.name.localeCompare(b.name));

                    }

                    else if (source === 'velara') {
                        const data = await fetchJson(this.SOURCE_CONFIG.velara.games);

                        return data.filter(g => g.name !== '!!DMCA' && g.name !== '!!Game Request').map(game => {
                            let finalUrl = game.link;
                            let isExternal = false;

                            if (finalUrl) {
                                if (!finalUrl.startsWith('http')) {
                                    finalUrl = resolveUrl(finalUrl, this.SOURCE_CONFIG.velara.assets);
                                }
                            }

                            else if (game.grdmca) {
                                finalUrl = game.grdmca;
                                isExternal = true;
                            }

                            return {
                                id: game.name,
                                name: game.name,
                                author: 'Velara',
                                // FORCE PROXY on images
                                coverUrl: proxyImage(resolveUrl(`assets/game-imgs/${game.imgpath}`, this.SOURCE_CONFIG.velara.assets)),
                                gameUrl: finalUrl,
                                isExternal: isExternal,
                                featured: false
                            }

                                ;
                        }).sort((a, b) => a.name.localeCompare(b.name));

                    }

                    else if (source === 'duckMath') {
                        const data = await fetchJson(this.SOURCE_CONFIG.duckMath.games);

                        return data.map(game => ({
                            id: game.id,
                            name: game.title.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                            author: game.developer_name || 'DuckMath',
                            // FORCE PROXY on images
                            coverUrl: proxyImage(game.icon),
                            gameUrl: game.link,
                            isExternal: false,
                            featured: game.is_featured || false
                        })).sort((a, b) => a.name.localeCompare(b.name));

                    }

                    else {
                        // gnMath Source Handler
                        const data = await fetchJson(this.SOURCE_CONFIG.gnMath.zones);

                        return data.map(zone => {
                            const isExternal = zone.url.startsWith('http');
                            let rawCoverUrl = zone.cover.replace('{COVER_URL}', this.SOURCE_CONFIG.gnMath.covers);
                            let rawGameUrl = isExternal ? zone.url : zone.url.replace('{HTML_URL}', this.SOURCE_CONFIG.gnMath.html);

                            return {
                                id: zone.id,
                                name: zone.name,
                                author: zone.author,
                                // FORCE PROXY on images
                                coverUrl: proxyImage(rawCoverUrl),
                                gameUrl: rawGameUrl,
                                isExternal: isExternal
                            }

                                ;
                        }).filter(g => g !== null && !g.name.startsWith('[!]'));
                    }
                }

                catch (e) {
                    throw e;
                }
            }
        }

        window.ActivitiesManager = ActivitiesManager;

    </script>
    <script>function initGlassSearch(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const glassSearch = container.querySelector('.glass-search');
            const searchInput = container.querySelector('.search-input');
            const searchSuggestions = container.querySelector('.search-suggestions');
            const suggestionsList = container.querySelector('.suggestion-group ul');
            const specular = glassSearch.querySelector('.glass-specular');





            if (glassSearch) {
                glassSearch.addEventListener('mousemove', (e) => {
                    const rect = glassSearch.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    if (specular) {
                        specular.style.background = `radial-gradient(circle at ${x}

                                px ${y}

                                px,
                                rgba(255, 255, 255, 0.15) 0%,
                                rgba(255, 255, 255, 0.05) 30%,
                                rgba(255, 255, 255, 0) 60%)`;
                    }
                });

                glassSearch.addEventListener('mouseleave', () => {
                    if (specular) {
                        specular.style.background = 'none';
                    }
                });
            }

            if (searchInput && searchSuggestions) {
                searchInput.addEventListener('focus', () => {
                    if (searchInput.value.trim().length > 0) {
                        fetchSuggestions(searchInput.value.trim(), suggestionsList);
                        searchSuggestions.classList.add('active');
                    }
                });

                searchInput.addEventListener('blur', (e) => {
                    if (!e.relatedTarget || !e.relatedTarget.closest('.search-suggestions')) {
                        setTimeout(() => {
                            searchSuggestions.classList.remove('active');
                            const container = searchInput.closest('.search-container');
                            if (container) container.classList.remove('expanded');
                        }, 200);
                    }
                });

                let debounceTimer;

                searchInput.addEventListener('input', (e) => {
                    const val = e.target.value.trim();
                    clearTimeout(debounceTimer);

                    if (val.length === 0) {
                        searchSuggestions.classList.remove('active');
                        return;
                    }

                    debounceTimer = setTimeout(() => {
                        fetchSuggestions(val, suggestionsList);
                        searchSuggestions.classList.add('active');
                    }, 300);
                });
            }


            if (suggestionsList) {
                suggestionsList.addEventListener('click', (e) => {
                    const li = e.target.closest('li');

                    if (li) {
                        const text = li.innerText.trim();

                        if (searchInput) {
                            searchInput.value = text;
                            searchSuggestions.classList.remove('active');
                            searchInput.focus();

                            const tabId = glassSearch.closest('.tab-content').id;

                            if (window.tManager) {
                                window.tManager.navigateTab(tabId, text);
                            }
                        }
                    }
                });
            }
        }

        async function fetchSuggestions(query, ul) {
            if (!ul) return;

            try {
                const res = await fetch(`/math/suggestions?q=${encodeURIComponent(query)}

                    `);
                const suggestions = await res.json();

                if (suggestions.length === 0) {
                    ul.innerHTML = '<li style="pointer-events:none; opacity:0.5; justify-content:center;"><i>No suggestions</i></li>';
                }

                else {
                    ul.innerHTML = suggestions.map(item => ` <li><i class="fas fa-search" ></i><span>${escapeHtml(item)}

                        </span></li> `).join('');
                }
            }

            catch (e) {
                ul.innerHTML = '';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.initGlassSearch = initGlassSearch;

    </script>
    <script>window.AuthManager = {
            socket: null,

            init() {
                if (this.socket) return; // Already initialized

                if (typeof io === 'undefined') {

                    return;
                }

                window.attemptLogin = () => {
                    const user = document.getElementById('auth-login-user').value;
                    const pass = document.getElementById('auth-login-pass').value;

                    this.socket.emit('login', {
                        username: user, password: pass
                    });
                }

                    ;

                window.attemptSignup = () => {
                    const user = document.getElementById('auth-signup-user').value;
                    const pass = document.getElementById('auth-signup-pass').value;
                    const email = document.getElementById('auth-signup-email').value;

                    this.socket.emit('signup', {
                        username: user, password: pass, email: email
                    });
                }

                    ;

                window.attempt2FA = () => {
                    const user = localStorage.getItem('temp-auth-user') || document.getElementById('auth-login-user').value;
                    const code = document.getElementById('auth-2fa-code').value;

                    this.socket.emit('verify2FA', {
                        username: user, code
                    });
                }

                window.playAsGuest = () => {
                    localStorage.removeItem('light-auth-token');
                    localStorage.removeItem('light-auth-username');
                    localStorage.removeItem('void_username');
                    localStorage.setItem('light-guest-mode', 'true');
                    document.getElementById('auth-overlay').style.display = 'none';
                    if (window.autoCreateProfile) window.autoCreateProfile();
                    const u = localStorage.getItem('light-auth-username') || localStorage.getItem('void_username') || 'Guest';
                    if (window.AuthManager && window.AuthManager.showWelcome) window.AuthManager.showWelcome(u);
                    if (window.AuthManager && window.AuthManager.resolveAuth) window.AuthManager.resolveAuth();
                }

                    ;

                window.switchAuthMode = (mode) => {
                    document.querySelectorAll('.auth-view').forEach(el => el.style.display = 'none');

                    document.getElementById(`auth-view-${mode}`).style.display = 'flex';
                    document.querySelectorAll('.auth-error').forEach(el => el.style.display = 'none');
                }

                const token = localStorage.getItem('light-auth-token');
                const username = localStorage.getItem('light-auth-username');

                this.socket = io({

                    path: '/profiles/socket.io/',
                    auth: {
                        username: username, token: token
                    }

                    ,
                    transports: ['websocket']
                });

                this.bindEvents();

                // checkTOS logic removed in favor of controlled flow
            }

            ,

            startAuthFlow() {
                return new Promise((resolve) => {
                    // Check if we are already dealing with a flow
                    this.resolveAuth = resolve;

                    const token = localStorage.getItem('light-auth-token');
                    const username = localStorage.getItem('light-auth-username');

                    if (localStorage.getItem('light-tos-accepted') !== 'true') {
                        // If TOS not accepted, wait for it.
                        // The TOS acceptance flow should eventually call AuthManager.startAuthFlow() again
                        // or directly resolve the promise if it handles the auth itself.
                        // For now, we'll assume the TOS acceptance will trigger a reload or
                        // another call to startAuthFlow.
                        // Or, more robustly, the TOS component should resolve this promise.
                        // For this specific change, we'll assume TOS is handled externally
                        // or that the checkTOS logic is now part of the external caller.
                        // If the original checkTOS was meant to wait, this promise will remain pending.
                        // Let's re-introduce the TOS check here for completeness, but without polling.
                        // The external code calling startAuthFlow should ensure TOS is accepted first.
                        // If not, this promise will not resolve until an auth action happens.
                        // For now, we proceed as if TOS is accepted, as per the diff.
                    }

                    if (token && username) {
                        this.socket.emit('verifyToken', {
                            username, token
                        });
                        // resolveAuth will be called in authSuccess or authError
                    }

                    else if (localStorage.getItem('light-guest-mode') === 'true') {
                        document.getElementById('auth-overlay').style.display = 'none';
                        if (window.autoCreateProfile) window.autoCreateProfile();
                        const u = localStorage.getItem('light-auth-username') || localStorage.getItem('void_username') || 'Guest';
                        this.showWelcome(u);
                        resolve();
                    }

                    else {
                        this.showLogin();
                        // resolveAuth will be called after login/signup/guest
                    }
                });
            }

            ,

            bindEvents() {
                this.socket.on('authSuccess', ({
                    username, token, email

                }) => {
                    localStorage.setItem('light-auth-token', token);
                    localStorage.setItem('light-auth-username', username);
                    localStorage.setItem('void_username', username);
                    localStorage.removeItem('light-guest-mode');
                    if (email) localStorage.setItem('light-auth-email', email); else localStorage.removeItem('light-auth-email');

                    document.getElementById('auth-overlay').style.display = 'none';
                    this.showWelcome(username);
                });

                this.socket.on('authError', ({
                    msg

                }) => {
                    const errorEls = document.querySelectorAll('.auth-error');

                    errorEls.forEach(el => {
                        el.textContent = msg;
                        el.style.display = 'block';
                    });

                    if (msg === 'Invalid session') {
                        localStorage.removeItem('light-auth-token');
                        this.showLogin();
                    }
                });

                this.socket.on('auth2FARequired', ({
                    username

                }) => {
                    localStorage.setItem('temp-auth-user', username);
                    window.switchAuthMode('2fa');
                });

                this.socket.on('profileUpdateSuccess', ({
                    username, token, email

                }) => {
                    localStorage.setItem('light-auth-username', username);
                    localStorage.setItem('void_username', username);
                    if (token) localStorage.setItem('light-auth-token', token);
                    if (email) localStorage.setItem('light-auth-email', email); else localStorage.removeItem('light-auth-email');
                    alert('profile updated successfully!');
                    location.reload();
                });

                this.socket.on('accountDeleted', () => {
                    localStorage.clear();
                    location.reload();
                });

                this.socket.on('notification', (notif) => {
                    this.showToast(`<strong>${notif.title}

                    </strong><br>${notif.message}

                    `, 'bell');

                    window.dispatchEvent(new CustomEvent('light:notification', {
                        detail: notif
                    }));
                });
            }

            ,

            showToast(message, icon = 'bell') {
                let container = document.getElementById('toast-container');

                if (!container) {
                    container = document.createElement('div');
                    container.id = 'toast-container';
                    container.style.cssText = 'position:fixed; top:20px; right:20px; z-index:999999; display:flex; flex-direction:column; gap:10px; pointer-events:none;';
                    document.body.appendChild(container);
                }

                const toast = document.createElement('div');
                toast.style.cssText = 'background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 12px 20px; border-radius: 12px; font-size: 0.9rem; transform: translateX(100%); transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1); display:flex; align-items:center; box-shadow: 0 4px 15px rgba(0,0,0,0.3);';

                toast.innerHTML = `<i data-lucide="${icon}" style="margin-right:10px; color:#60a5fa; width: 20px; height: 20px;"></i><div>${message}

            </div>`;

                lucide.createIcons({
                    root: toast
                });

                container.appendChild(toast);

                requestAnimationFrame(() => {
                    toast.style.transform = 'translateX(0)';
                });

                setTimeout(() => {
                    toast.style.transform = 'translateX(120%)';
                    setTimeout(() => toast.remove(), 500);
                }

                    , 5000);
            }

            ,

            showWelcome(username) {
                this.showToast(`welcome, <strong>${username}

                </strong>`, 'smile');
            }

            ,

            showLogin() {
                const overlay = document.getElementById('auth-overlay');

                if (overlay) {
                    overlay.style.display = 'flex';
                    window.switchAuthMode('login');
                }
            }
        }

            ;

        window.addEventListener('load', () => {
            setTimeout(() => window.AuthManager.init(), 100);
        });
    </script>
    <script>
        /*
(function initVanta() {
    let vantaInstance = null;
    const init = () => {
        if (window.VANTA && !vantaInstance) {
            try {
                vantaInstance = VANTA.TOPOLOGY({
                    el: "#vanta-bg",
                    mouseControls: true,
                    touchControls: true,
                    gyroControls: false,
                    minHeight: 200.00,
                    minWidth: 200.00,
                    scale: 1.00,
                    scaleMobile: 1.00,
                    color: "#2f2f2f",
                    backgroundColor: "#000000"
                });
            } catch (err) {
            }
        }
    };
 
    if (document.readyState === 'complete') {
        init();
    } else {
        window.addEventListener('load', init);
    }
})();
*/

        function initMagneticUI() {
            const magnets = document.querySelectorAll('.dock-app, #music-trigger, .mp-btn, .mp-card, .nt-search-icon, .st-btn, .st-select, .nt-search-box, .mp-search, .glass-search');
            magnets.forEach(makeMagnetic);
        }

        function makeMagnetic(el) {
            if (el.dataset.magnetic) return;
            el.dataset.magnetic = "true";

            el.addEventListener('mousemove', (e) => {
                if ((document.body.classList.contains('tab-style-dots') || document.body.classList.contains('tab-style-radial')) && el.classList.contains('tab-item')) return;

                const rect = el.getBoundingClientRect();
                const x = e.clientX - rect.left - rect.width / 2;
                const y = e.clientY - rect.top - rect.height / 2;
                const strength = 0.05;
                const maxMove = 15;
                const moveX = Math.max(Math.min(x * strength, maxMove), -maxMove);
                const moveY = Math.max(Math.min(y * strength, maxMove), -maxMove);

                el.style.transform = `translate(${moveX}

                        px, ${moveY}

                        px)`;
                el.style.transition = 'transform 0.1s ease-out';
            });

            el.addEventListener('mouseleave', () => {
                if ((document.body.classList.contains('tab-style-dots') || document.body.classList.contains('tab-style-radial')) && el.classList.contains('tab-item')) {
                    return;
                }

                el.style.transform = 'translate(0, 0)';
                el.style.transition = 'transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1)';
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            initMagneticUI();
        });
        setInterval(initMagneticUI, 2000);
        document.querySelectorAll('.dock-app, #new-tab-btn').forEach(el => makeMagnetic(el));

        window.updateWeather = updateWeather;

        async function updateWeather() {
            try {
                const res = await fetch('/math/weather');
                const data = await res.json();

                if (!data || !data.success || !data.text) throw new Error("Invalid response");

                // Server returns "Condition TempF" (e.g. "Rain Showers 70F")
                const parts = data.text.split(' ');
                const tempStr = parts.pop();
                const condition = parts.join(' ').trim().toLowerCase();
                const temp = tempStr.replace(/[^0-9-]/g, '');

                let icon = 'sun';
                if (condition.includes('cloud') || condition.includes('overcast') || condition.includes('clear')) icon = 'cloud-sun';
                if (condition.includes('fog') || condition.includes('mist')) icon = 'cloud-fog';
                if (condition.includes('rain') || condition.includes('drizzle') || condition.includes('shower')) icon = 'cloud-rain';
                if (condition.includes('snow') || condition.includes('ice') || condition.includes('freez')) icon = 'snowflake';
                if (condition.includes('thunder')) icon = 'cloud-lightning';
                if (condition === 'clear' || condition === 'mostly clear') icon = 'sun';

                const display = `${temp}f | ${condition}`;

                document.querySelectorAll('.nt-clock').forEach(el => {
                    el.innerHTML = `<i data-lucide="${icon}" style="width:50px;height:50px; stroke-width: 2.5px;"></i> ${display}`;
                    lucide.createIcons({ root: el });
                    el.style.cursor = "default";
                    el.onclick = null;
                });
            } catch (e) {
                console.error("Weather fetch failed:", e);
                const fallback = "70f | clear";
                document.querySelectorAll('.nt-clock').forEach(el => {
                    el.innerHTML = `<i data-lucide="sun" style="width:50px;height:50px; stroke-width: 2.5px;"></i> ${fallback}`;
                    lucide.createIcons({ root: el });
                });
            }
        }

        if (window.proxyReady) {
            window.proxyReady.then(() => {
                updateWeather();
                setInterval(updateWeather, 600000);
            });
        }

        window.addEventListener('beforeunload', (e) => {
            if (localStorage.getItem('light-close-warning') === 'true') {
                e.preventDefault();
                e.returnValue = '';
            }
        });




        (function initLoadingAnimation() {
            const canvas = document.getElementById('loading-canvas');
            const ctx = canvas.getContext('2d');
            const brand = document.getElementById('loading-brand');
            const screen = document.getElementById('loading-screen');

            let width, height, nodes = [];
            const nodeCount = 40;
            const maxDist = 150;

            function resize() {
                width = canvas.width = window.innerWidth;
                height = canvas.height = window.innerHeight;
            }

            window.addEventListener('resize', resize);
            resize();

            for (let i = 0; i < nodeCount; i++) {
                nodes.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    vx: (Math.random() - 0.5) * 1.5,
                    vy: (Math.random() - 0.5) * 1.5,
                    r: Math.random() * 2 + 1
                });
            }

            let startTime = Date.now();
            let duration = 3500;

            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);

                ctx.clearRect(0, 0, width, height);

                nodes.forEach((node, i) => {
                    node.x += node.vx;
                    node.y += node.vy;

                    if (node.x < 0 || node.x > width) node.vx *= -1;
                    if (node.y < 0 || node.y > height) node.vy *= -1;

                    ctx.beginPath();
                    ctx.arc(node.x, node.y, node.r, 0, Math.PI * 2);

                    ctx.fillStyle = `rgba(255, 255, 255, ${0.4 * progress})`;
                    ctx.fill();

                    for (let j = i + 1; j < nodes.length; j++) {
                        const other = nodes[j];
                        const dx = node.x - other.x;
                        const dy = node.y - other.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);

                        if (dist < maxDist) {
                            const alpha = (1 - dist / maxDist) * 0.2 * progress;
                            ctx.beginPath();
                            ctx.moveTo(node.x, node.y);
                            ctx.lineTo(other.x, other.y);

                            ctx.strokeStyle = `rgba(255, 255, 255, ${alpha * 2})`;
                            ctx.lineWidth = 0.5;
                            ctx.stroke();
                        }
                    }
                });

                if (progress > 0.2) brand.classList.add('visible');

                if (progress < 1) {
                    requestAnimationFrame(animate);
                }

                else {
                    // Animation done, waiting for manual dismissal
                }
            }

            window.hideLoadingScreen = () => {
                if (screen) {
                    screen.classList.add('fade-out');
                    setTimeout(() => screen.remove(), 1000);
                }
            }

                ;

            animate();
        })();

        const contextMenu = document.getElementById('custom-context-menu');

        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();

            const x = e.clientX;
            const y = e.clientY;

            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';

            const menuRect = contextMenu.getBoundingClientRect();

            if (x + 180 > window.innerWidth) {
                contextMenu.style.left = (x - 180) + 'px';
            }

            if (y + 150 > window.innerHeight) {
                contextMenu.style.top = (y - 150) + 'px';
            }

            contextMenu.classList.add('active');
        });

        document.addEventListener('click', () => {
            contextMenu.classList.remove('active');
        });

        document.addEventListener('scroll', () => {
            contextMenu.classList.remove('active');
        });

        function contextMenuAction(action) {
            contextMenu.classList.remove('active');

            switch (action) {
                case 'profiles':
                    tManager.addTab('app-iframe', '/profiles/', 'Profiles');
                    break;
                case 'settings':
                    openSettingsModal();
                    break;
                case 'newtab':
                    tManager.addTab('newtab');
                    break;
            }
        }

        function clearGlassSearch(btn) {
            const container = btn.closest('.glass-search');
            const input = container.querySelector('.search-input');
            const suggestions = container.querySelector('.search-suggestions');

            if (input) {
                input.value = '';
                input.dispatchEvent(new Event('input'));
                input.dispatchEvent(new Event('change'));
                input.focus();
            }

            if (suggestions) suggestions.classList.remove('active');
        }

        window.clearGlassSearch = clearGlassSearch;

    </script>
    <script>function renderCalculator(container) {
            container.innerHTML = ` <div style="display:flex; flex-direction:column; height:100%; padding:10px;"><input type="text" id="calc-display" readonly style="width:100%; padding:20px; font-size:32px; text-align:right; margin-bottom:15px; border:none; border-radius:12px; background:rgba(255,255,255,0.05); color:#fff; backdrop-filter:blur(5px);"><div style="flex:1; display:grid; grid-template-columns:repeat(4, 1fr); gap:10px;"><button class="calc-btn btn-op" onclick="calcAppend('C')">C</button><button class="calc-btn btn-op" onclick="calcAppend('/')">/</button><button class="calc-btn btn-op" onclick="calcAppend('*')"></button><button class="calc-btn btn-op" onclick="calcAppend('bs')"></button><button class="calc-btn" onclick="calcAppend('7')">7</button><button class="calc-btn" onclick="calcAppend('8')">8</button><button class="calc-btn" onclick="calcAppend('9')">9</button><button class="calc-btn btn-op" onclick="calcAppend('-')">-</button><button class="calc-btn" onclick="calcAppend('4')">4</button><button class="calc-btn" onclick="calcAppend('5')">5</button><button class="calc-btn" onclick="calcAppend('6')">6</button><button class="calc-btn btn-op" onclick="calcAppend('+')">+</button><button class="calc-btn" onclick="calcAppend('1')">1</button><button class="calc-btn" onclick="calcAppend('2')">2</button><button class="calc-btn" onclick="calcAppend('3')">3</button><button class="calc-btn btn-eq" onclick="calcCalculate()" style="grid-row:span 2;">=</button><button class="calc-btn" onclick="calcAppend('0')" style="grid-column:span 2;">0</button><button class="calc-btn" onclick="calcAppend('.')">.</button></div></div><style>.calc-btn {
                border: 1px solid rgba(255, 255, 255, 0.05);
                border-radius: 12px;
                background: rgba(255, 255, 255, 0.03);
                color: #fff;
                font-size: 20px;
                cursor: pointer;
                transition: 0.2s;
            }

            .calc-btn:hover {
                background: rgba(255, 255, 255, 0.1);
                transform: translateY(-2px);
            }

            .calc-btn:active {
                transform: scale(0.95);
            }

            .btn-op {
                color: #60a5fa;
            }

            .btn-eq {
                background: #60a5fa;
                color: #000;
                font-weight: bold;
            }

            .btn-eq:hover {
                background: #93c5fd;
            }
    </style>
    `;
            window.calcDisplay = container.querySelector('#calc-display');
        }

        window.calcAppend = function (val) {
            let d = window.calcDisplay;
            if (val === 'C') d.value = '';
            else if (val === 'bs') d.value = d.value.slice(0, -1);
            else d.value += val;
        }

        window.calcCalculate = function () {
            try { window.calcDisplay.value = eval(window.calcDisplay.value) || ''; }
            catch { window.calcDisplay.value = 'Error'; }
        }

        function renderPaint(container) {
            container.innerHTML = `
    <div style="height:100%; display:flex; flex-direction:column;">
        <div style="padding:15px; background:rgba(0,0,0,0.2); display:flex; gap:15px; align-items:center;">
            <input type="color" id="paint-color" value="#ffffff"
                style="width:40px; height:40px; border:none; border-radius:8px; cursor:pointer;">
            <div style="display:flex; flex-direction:column; gap:2px;">
                <span style="font-size:10px; color:#aaa;">Size</span>
                <input type="range" id="paint-size" min="1" max="20" value="5" style="width:100px;">
            </div>
            <button class="btn" onclick="paintClear()">Clear</button>
            <button class="btn" onclick="paintSave()">Save</button>
        </div>
        <div style="flex:1; position:relative; overflow:hidden; background:#111; cursor:crosshair;" id="paint-area">
            <canvas id="paint-canvas"></canvas>
        </div>
    </div>
    <style>
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
    `;

            const canvas = container.querySelector('#paint-canvas');
            const parent = container.querySelector('#paint-area');
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;

            const ctx = canvas.getContext('2d');
            let painting = false;

            function startPosition(e) { painting = true; draw(e); }
            function finishedPosition() { painting = false; ctx.beginPath(); }

            function draw(e) {
                if (!painting) return;
                const rect = canvas.getBoundingClientRect();
                ctx.lineWidth = document.getElementById('paint-size').value;
                ctx.lineCap = 'round';
                ctx.strokeStyle = document.getElementById('paint-color').value;
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            }

            canvas.addEventListener('mousedown', startPosition);
            canvas.addEventListener('mouseup', finishedPosition);
            canvas.addEventListener('mousemove', draw);

            window.paintClear = () => ctx.clearRect(0, 0, canvas.width, canvas.height);
            window.paintSave = () => {
                const link = document.createElement('a');
                link.download = 'drawing.png';
                link.href = canvas.toDataURL();
                link.click();
            };
        }

        function renderOSSettings(container) {
            container.style.cssText = 'padding:0; color:#fff; height:100%; overflow-y:auto; background:transparent;';

            if (!document.getElementById('settings-css')) {
                const style = document.createElement('style');
                style.id = 'settings-css';
                style.textContent = `
    .settings-container { max-width: 680px; margin: 0 auto; padding: 48px 32px; }
    .settings-header { margin-bottom: 40px; text-align: center; }
    .settings-header h1 { font-size: 2rem; font-weight: 700; letter-spacing: -1px; margin-bottom: 8px; color: #fff; }
    .settings-header p { display: none; }

    .settings-section { margin-bottom: 36px; }
    .section-title { font-size: 0.8rem; font-weight: 600; color: rgba(255,255,255,0.5); margin-bottom: 16px;
    padding-left: 4px; letter-spacing: 0.5px; }

    .setting-card {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 18px;
    overflow: hidden;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    }
    .setting-card:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(255, 255, 255, 0.12);
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.15);
    }

    .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px;
    border-bottom: 1px solid rgba(255,255,255,0.05); }
    .setting-row.link-row { cursor: pointer; text-decoration: none; color: inherit; transition: background 0.2s; }
    .setting-row.link-row:hover { background: rgba(255,255,255,0.08); }
    .setting-row:last-child { border-bottom: none; }

    .setting-info { flex: 1; margin-right: 24px; }
    .setting-name { font-size: 1rem; font-weight: 600; margin-bottom: 4px; color: #fff; }
    .setting-desc { font-size: 0.85rem; color: rgba(255,255,255,0.5); line-height: 1.4; }

    .st-select {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #fff;
    padding: 10px 14px;
    border-radius: 10px;
    outline: none;
    cursor: pointer;
    min-width: 150px;
    font-size: 0.9rem;
    transition: all 0.2s;
    font-family: inherit;
    }
    .st-select:hover { border-color: rgba(255, 255, 255, 0.25); background: rgba(0, 0, 0, 0.3); }
    .st-select:focus { border-color: #60a5fa; box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2); }

    .st-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.05);
    color: #fff;
    padding: 10px 16px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
    font-weight: 600;
    }
    .st-btn:hover { background: rgba(255, 255, 255, 0.15); transform: translateY(-1px); }
    .st-btn:active { transform: scale(0.96); }

    .st-btn.danger { background: rgba(239, 68, 68, 0.1); color: #f87171; border-color: rgba(239, 68, 68, 0.2); }
    .st-btn.danger:hover { background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.3); }

    @keyframes fadeInUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
    `;
                document.head.appendChild(style);
            }

            let proxyVal = localStorage.getItem('light-proxy-transport');
            let searchVal = localStorage.getItem('light-search-engine');

            container.innerHTML = `
            <div class="settings-container">
                <div class="settings-header">
                    <h1>settings</h1>
                </div>
                <div class="settings-section">
                    <div class="section-title">general</div>
                    <div class="setting-card">
                        <!-- Tab Style selection removed - vertical only -->
                        <div class="setting-row" id="wisp-url-row" style="${localStorage.getItem('light-dynamic-wisp') !== 'false' ? 'display:none' : ''}">
                            <div class="setting-info">
                                <div class="setting-name">wisp server</div>
                            </div>
                            <input type="text" class="st-select" placeholder="wss://wisp.lightlink.space" value="${localStorage.getItem('light-wss-url') || ''}" onchange="window.updateWisp ? window.updateWisp(this.value) : localStorage.setItem('light-wss-url', this.value)" style="width:180px;">
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-name">search engine</div>
                            </div>
                            <select class="st-select" onchange="localStorage.setItem('light-search-engine', this.value)">
                                <option value="duckduckgo" ${searchVal !== 'google' && searchVal !== 'bing' ? 'selected' : ''}>DuckDuckGo</option>
                                <option value="google" ${searchVal === 'google' ? 'selected' : ''}>Google</option>
                                <option value="bing" ${searchVal === 'bing' ? 'selected' : ''}>Bing</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-name">activities source</div>
                            </div>
                            <select class="st-select" onchange="if(window.ActivitiesManager && window.ActivitiesManager.updateProvider){window.ActivitiesManager.updateProvider(this.value);}else{localStorage.setItem('light-activities-provider',this.value);location.reload();}">
                                <option value="truffled" ${localStorage.getItem('light-activities-provider') === 'truffled' || !localStorage.getItem('light-activities-provider') ? 'selected' : ''}>Truffled</option>
                                <option value="gnMath" ${localStorage.getItem('light-activities-provider') === 'gnMath' ? 'selected' : ''}>GN-Math</option>
                                <option value="selenite" ${localStorage.getItem('light-activities-provider') === 'selenite' ? 'selected' : ''}>Selenite</option>
                                <option value="velara" ${localStorage.getItem('light-activities-provider') === 'velara' ? 'selected' : ''}>Velara</option>
                                <option value="duckMath" ${localStorage.getItem('light-activities-provider') === 'duckMath' ? 'selected' : ''}>DuckMath</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-name">close warning</div>
                            </div>
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                                <input type="checkbox" id="close-warning-toggle" ${localStorage.getItem('light-close-warning') === 'true' ? 'checked' : ''} onchange="localStorage.setItem('light-close-warning', this.checked)" style="width:18px; height:18px; accent-color:#60a5fa;">
                            </label>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="section-title">privacy</div>
                    <div class="setting-card">
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-name">hidden cloak</div>
                            </div>
                            <button class="st-btn" onclick="window.openSecureTab()">open</button>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-name">auto-cloak</div>
                            </div>
                            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                                <input type="checkbox" id="cloak-toggle" ${localStorage.getItem('light-cloak-enabled') === 'true' ? 'checked' : ''} onchange="localStorage.setItem('light-cloak-enabled', this.checked); if(this.checked) alert('cloak enabled: it works when your cursor leaves the window. click anywhere when it opens to exit it.');" style="width:18px; height:18px; accent-color:#60a5fa;">
                            </label>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-name">cloak url</div>
                            </div>
                            <input type="text" class="st-select" placeholder="https://google.com" value="${localStorage.getItem('light-cloak-url') || 'https://google.com'}" onchange="localStorage.setItem('light-cloak-url', this.value)" style="width:180px;">
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="section-title">data</div>
                    <div class="setting-card">
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-name">export data</div>
                            </div>
                            <button class="st-btn" onclick="exportLightData()">export</button>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-name">import data</div>
                            </div>
                            <label class="st-btn" style="cursor:pointer;">import<input type="file" accept=".lightdata" style="display:none;" onchange="importLightData(this.files[0])"></label>
                        </div>
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-name">reset all</div>
                            </div>
                            <button class="st-btn danger" onclick="if(confirm('reset all data?')){localStorage.clear(); location.reload();}">reset</button>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="section-title">feedback</div>
                    <div class="setting-card">
                        <div class="setting-row" style="flex-direction:column; align-items:stretch; gap:12px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div class="setting-info" style="margin-right:0;">
                                    <div class="setting-name">send feedback</div>
                                </div>
                                <select class="st-select" id="feedback-type" style="min-width:120px;">
                                    <option value="General">general</option>
                                    <option value="BugReport">bug report</option>
                                    <option value="FeatureRequest">feature request</option>
                                </select>
                            </div>
                            <textarea id="feedback-message" placeholder="message..." class="st-select" style="width:100%; min-height:100px; resize:vertical;" maxlength="2000"></textarea>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span id="feedback-status" style="font-size:0.75rem; color:rgba(255,255,255,0.4);"></span>
                                <button class="st-btn" id="send-feedback-btn" onclick="sendFeedback()"><i data-lucide="send" style="width:16px; height:16px; margin-right:6px;"></i>send</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="settings-section" id="account-settings-section">
                    <div class="section-title">account</div>
                    <div class="setting-card">
                        <div class="setting-row" style="flex-direction:column; align-items:stretch; gap:12px;">
                            ${(function () {
                    const isAuth = !!localStorage.getItem('light-auth-token');
                    const user = localStorage.getItem('light-auth-username') || localStorage.getItem('void_username') || 'guest';
                    const email = localStorage.getItem('light-auth-email') || '';
                    if (isAuth) {
                        return `
                                    <div class="setting-name">profile settings</div>
                                    <input type="text" id="acc-username" placeholder="username" value="${user}" class="st-select" style="width:100%">
                                    <input type="email" id="acc-email" placeholder="email" value="${email}" class="st-select" style="width:100%">
                                    <input type="password" id="acc-password" placeholder="password ()" class="st-select" style="width:100%">
                                    <button class="st-btn" onclick="saveProfileSettings()">save changes</button>
                                    <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); width:100%; margin: 16px 0;">
                                    <div style="display:flex; gap:10px;">
                                        <button class="st-btn" onclick="logoutAccount()">logout</button>
                                        <button class="st-btn danger" onclick="deleteAccount()">delete account</button>
                                    </div>`;
                    } else {
                        return `
                                    <div class="setting-name">guest settings</div>
                                    <input type="text" id="acc-username" placeholder="username" value="${user}" class="st-select" style="width:100%">
                                    <button class="st-btn" onclick="saveProfileSettings()">rename user</button>
                                    <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); width:100%; margin: 16px 0;">
                                    <div style="display:flex; gap:10px;">
                                        <button class="st-btn" onclick="logoutAccount()">logout (reset)</button>
                                        <button class="st-btn danger" onclick="deleteAccount()">clear data</button>
                                    </div>`;
                    }
                })()}
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="section-title">credits</div>
                    <div class="setting-card">
                        <a href="CREDITS.html" target="_blank" class="setting-row link-row">
                            <div class="setting-info">
                                <div class="setting-name">credits</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>`;

            if (window.makeMagnetic) {
                container.querySelectorAll('.st-btn, .st-select').forEach(window.makeMagnetic);
            }

            lucide.createIcons({
                root: container
            });
        }

        window.openAccountInSettings = function () {
            openSettingsModal();
            setTimeout(() => {
                const section = document.getElementById('account-settings-section');
                if (section) section.scrollIntoView({ behavior: 'smooth' });
            }, 300);
        }

        function exportLightData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i); if (key.startsWith('light-')) {
                    data[key] = localStorage.getItem(key);
                }
            } const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            }); const url = URL.createObjectURL(blob); const a = document.createElement('a');
            a.href = url; a.download = 'settings.lightdata'; a.click(); URL.revokeObjectURL(url);
        } function
            importLightData(file) {
            if (!file) return; const reader = new FileReader(); reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    for (const [key, value] of Object.entries(data)) {
                        if (key.startsWith('light-')) {
                            localStorage.setItem(key, value);
                        }
                    }
                    location.reload();
                } catch {
                    alert('Invalid file');
                }
            };
            reader.readAsText(file);
        }

        async function sendFeedback() {
            const messageEl = document.getElementById('feedback-message');
            const typeEl = document.getElementById('feedback-type');
            const statusEl = document.getElementById('feedback-status');
            const btnEl = document.getElementById('send-feedback-btn');

            const message = messageEl.value.trim();
            const feedbackType = typeEl.value;
            const username = localStorage.getItem('void_username') || null;

            if (!message) {
                statusEl.textContent = 'please enter a message';
                statusEl.style.color = '#f87171';
                return;
            }

            btnEl.disabled = true;
            btnEl.innerHTML = '<i data-lucide="loader" style="margin-right:6px; animation: spin 1s linear infinite;"></i> sending...';
            lucide.createIcons({ root: btnEl });
            statusEl.textContent = '';

            try {
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, feedbackType, username })
                });

                const data = await response.json();

                if (data.success) {
                    statusEl.textContent = ' feedback sent! thank you.';
                    statusEl.style.color = '#4ade80';
                    messageEl.value = '';
                } else {
                    statusEl.textContent = data.error || 'failed to send feedback';
                    statusEl.style.color = '#f87171';
                }
            } catch (error) {
                statusEl.textContent = 'network error. please try again.';
                statusEl.style.color = '#f87171';
            }

            btnEl.disabled = false;
            btnEl.innerHTML = '<i data-lucide="send" style="margin-right:6px;"></i>send feedback';
            lucide.createIcons({ root: btnEl });
        }

        async function switchProxyTransport(value) {
            localStorage.setItem('light-proxy-transport', value);

            if (!('serviceWorker' in navigator)) {
                location.reload();
                return;
            }

            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const reg of registrations) {
                    await reg.unregister();
                }
                const swPath = value === 'uv' ? '/uv.worker.js' : '/sj.worker.js';
                const registration = await navigator.serviceWorker.register(swPath, {
                    scope: '/',
                    type: 'module'
                });
                if (registration.installing) {
                    await new Promise((resolve) => {
                        registration.installing.addEventListener('statechange', (e) => {
                            if (e.target.state === 'activated') resolve();
                        });
                        setTimeout(resolve, 3000);
                    });
                }

                if (!navigator.serviceWorker.controller) {
                    await new Promise((resolve) => {
                        const timeout = setTimeout(resolve, 2000);
                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            clearTimeout(timeout);
                            resolve();
                        }, { once: true });
                    });
                }


                if (value === 'scramjet' && window.initScramjetController) {
                    await window.initScramjetController();
                }

            } catch (e) {
                location.reload();
            }
        }

        window.saveSMTPSettings = async function () {
            const password = document.getElementById('admin-password').value;
            const host = document.getElementById('smtp-host').value;
            const port = document.getElementById('smtp-port').value;
            const user = document.getElementById('smtp-user').value;
            const pass = document.getElementById('smtp-pass').value;

            if (!password) return alert("admin password required");

            try {
                const res = await fetch('/profiles/admin/config/smtp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password, host, port, user, pass })
                });
                const data = await res.json();
                alert(data.msg || data.error);
            } catch (e) { alert("Error updating settings"); }
        };

        window.saveProfileSettings = async function () {
            const newUsername = document.getElementById('acc-username').value;
            const newEmail = document.getElementById('acc-email') ? document.getElementById('acc-email').value : undefined;
            const newPassword = document.getElementById('acc-password') ? document.getElementById('acc-password').value :
                undefined;

            if (!newUsername) return alert("Username required");

            const currentUsername = localStorage.getItem('light-auth-username') || localStorage.getItem('void_username');
            const token = localStorage.getItem('light-auth-token');

            if (window.AuthManager && window.AuthManager.socket) {
                window.AuthManager.socket.emit('updateProfile', {
                    username: currentUsername,
                    token: token,
                    updates: { newUsername, newEmail, newPassword }
                });
            } else {
                alert("Connection error. Refresh the page.");
            }
        };

        window.logoutAccount = function () {
            localStorage.removeItem('light-auth-token');
            localStorage.removeItem('light-auth-username');
            localStorage.removeItem('light-auth-email');
            localStorage.removeItem('light-guest-mode');
            location.reload();
        }

        window.deleteAccount = function () {
            if (!confirm("Are you sure you want to delete your account? This cannot be undone.")) return;

            if (!localStorage.getItem('light-auth-token')) {
                localStorage.clear();
                location.reload();
                return;
            }

            const password = prompt("Please enter your password to confirm deletion:");
            if (!password) return;

            const username = localStorage.getItem('light-auth-username');
            const token = localStorage.getItem('light-auth-token');

            if (window.AuthManager && window.AuthManager.socket) {
                window.AuthManager.socket.emit('deleteAccount', { username, token, password });
            }
        };
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Check if onboarding has been seen
            const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding-v1');
            const currentStyle = localStorage.getItem('light-tab-style');

            if (!hasSeenOnboarding && currentStyle === 'dots') {
                initOnboarding();
            }
        });

        function initOnboarding() {
            if (document.getElementById('onboarding-overlay')) return;

            // Create Overlay Elements
            const overlay = document.createElement('div');
            overlay.id = 'onboarding-overlay';

            // Glow Area
            const glow = document.createElement('div');
            glow.className = 'onboarding-highlight-gw';
            overlay.appendChild(glow);

            // Tooltip Container
            const tooltip = document.createElement('div');
            tooltip.className = 'onboarding-tooltip arrow-bottom onboarding-step-1-pos';
            tooltip.innerHTML = `
                <i class="ri-mouse-line" style="margin-right:8px; vertical-align:middle;"></i>
                Hover the bottom area to reveal your tabs`;
            overlay.appendChild(tooltip);

            document.body.appendChild(overlay);

            // Start Sequence
            setTimeout(() => {
                overlay.classList.add('active');
                requestAnimationFrame(() => {
                    tooltip.classList.add('visible');
                });
            }, 1000);

            // Logic for Step 1 -> Step 2
            const bottomZone = document.querySelector('.bottom-hover-zone');

            let step1Complete = false;

            const handleBottomHover = () => {
                if (step1Complete) return;
                step1Complete = true;

                // User hovered bottom, transition to step 2
                tooltip.classList.remove('visible');
                glow.style.opacity = '0';

                setTimeout(() => {
                    // Update tooltip for Step 2
                    tooltip.classList.remove('arrow-bottom');
                    tooltip.classList.add('arrow-top'); // Actually we might want no arrow or different position
                    tooltip.classList.remove('onboarding-step-1-pos');
                    tooltip.classList.add('onboarding-step-2-pos'); // Define this class

                    tooltip.innerHTML = `
                        <i class="ri-arrow-up-line" style="margin-right:8px; vertical-align:middle;"></i>
                        Move back up to see the address bar`;

                    tooltip.classList.add('visible');

                    // Wait for user to leave bottom zone significantly or after a delay
                    const handleMouseLeave = (e) => {
                        if (e.clientY < window.innerHeight - 100) {
                            completeOnboarding();
                            document.removeEventListener('mousemove', handleMouseLeave);
                        }
                    };
                    document.addEventListener('mousemove', handleMouseLeave);

                }, 400); // Wait for tabs to likely appear
            };

            bottomZone.addEventListener('mouseenter', handleBottomHover);

            function completeOnboarding() {
                tooltip.classList.remove('visible');
                overlay.classList.remove('active');

                setTimeout(() => {
                    overlay.remove();
                    localStorage.setItem('hasSeenOnboarding-v1', 'true');
                }, 600);
            }
        }
    </script>
    <script>
        window.addEventListener('load', async () => {
            // Coordinate initialization flow: TOS -> Auth -> App

            // 1. Initialize Auth Socket (Idempotent)
            if (window.AuthManager && window.AuthManager.init) {
                window.AuthManager.init();
            }

            // 2. Terms of Service
            if (window.startTOSFlow) {
                await window.startTOSFlow();
            }

            // 3. Authentication
            if (window.AuthManager && window.AuthManager.startAuthFlow) {
                await window.AuthManager.startAuthFlow();
            }

            // 4. Tab Manager (Application)
            if (window.initTabManager) {
                await window.initTabManager();
            }

            // 5. Hide Loading Screen
            if (window.hideLoadingScreen) {
                window.hideLoadingScreen();
            }

            // 6. Finalize Icons
            lucide.createIcons();
        });
    </script>



</body>
<style>
    /* Integrated Nav Controls in Dynamic Island */
    body.tab-style-dynamic .nav-controls.integrated {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-right: 12px;
        padding-right: 12px;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        height: 24px;
    }

    body.tab-style-dynamic .nav-controls.integrated .nav-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        transition: all 0.2s;
    }

    body.tab-style-dynamic .nav-controls.integrated .nav-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        transform: scale(1.1);
    }

    body.tab-style-dynamic .nav-controls.integrated .nav-btn i {
        width: 16px;
        height: 16px;
    }
</style>
<script>
    // Integrated Navigation Logic
    (function () {
        const originalUpdate = window.updateTabLayoutStyle;
        window.updateTabLayoutStyle = function (newStyle) {
            // Force vertical regardless of what is passed
            newStyle = 'vertical';
            document.body.className = document.body.className.replace(/tab-style-[\w-]+/g, '').trim();
            document.body.classList.add(`tab-style-${newStyle}`);
            localStorage.setItem('light-tab-style', newStyle);

            if (newStyle === 'dots' && !localStorage.getItem('hasSeenOnboarding-v1')) {
                if (typeof initOnboarding === 'function') initOnboarding();
            }

            const navControls = document.querySelector('.nav-controls');
            const tabBar = document.getElementById('tab-bar');
            const navBar = document.getElementById('nav-bar'); // Parent for controls

            if (newStyle === 'dynamic') {
                if (navControls && tabBar && !tabBar.contains(navControls)) {
                    // Move to tab bar (insert at beginning)
                    if (tabBar.querySelector('.tab-preview')) {
                        // If tabs exist, maybe before them? Or at start of bar
                        tabBar.insertBefore(navControls, tabBar.firstChild);
                    } else {
                        tabBar.insertBefore(navControls, tabBar.firstChild);
                    }
                    navControls.classList.add('integrated');
                }
            } else {
                if (navControls && navBar && !navBar.contains(navControls)) {
                    // Move back to nav bar
                    navBar.insertBefore(navControls, navBar.firstChild);
                    navControls.classList.remove('integrated');
                }
            }

            if (newStyle !== 'radial') {
                document.querySelectorAll('.tab-item').forEach(t => {
                    t.style.transform = '';
                    t.style.bottom = '';
                    t.style.zIndex = '';
                    t.style.transformOrigin = '';
                });
            }

            if (newStyle === 'radial' && window.updateRadialLayout) window.updateRadialLayout();

            if (window.tManager) window.tManager.updateLoadingBar();
        };

        // Re-apply current style to trigger move
        const currentStyle = localStorage.getItem('light-tab-style') || 'vertical';
        if (document.readyState === 'complete') {
            window.updateTabLayoutStyle(currentStyle);
        } else {
            window.addEventListener('load', () => window.updateTabLayoutStyle(currentStyle));
        }
    })();
</script>
</body>

</html>